<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFTCG External Database Integration Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/accessibility.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .api-status {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-width: 200px;
            flex: 1;
        }
        .status-card.online {
            border-color: #4caf50;
            background: #f1f8e9;
        }
        .status-card.offline {
            border-color: #f44336;
            background: #ffebee;
        }
        .status-card.unknown {
            border-color: #ff9800;
            background: #fff3e0;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .controls button {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }
        .controls button:hover {
            background: #f5f5f5;
        }
        .controls button.primary {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }
        .card-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .card-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .card-image {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .card-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .card-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .card-details {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        .source-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .source-ffdecks { background: #e3f2fd; color: #1976d2; }
        .source-fftcgdb { background: #f3e5f5; color: #7b1fa2; }
        .source-squareEnix { background: #fff3e0; color: #f57c00; }
        .source-fallback { background: #ffebee; color: #d32f2f; }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê FFTCG External Database Integration Test</h1>
            <p>Test integration with external FFTCG card databases including FFDecks, FFTCGDB, and Square Enix sources.</p>
        </header>

        <main>
            <!-- API Status Section -->
            <section class="test-section">
                <h2>üì° API Status & Health Monitoring</h2>
                <div id="apiStatus" class="api-status">
                    <div class="status-card unknown">
                        <h3>Checking...</h3>
                        <p>Initializing API connections...</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="checkAPIStatus()" class="primary">Check Status</button>
                    <button onclick="refreshAPIs()">Refresh All</button>
                    <button onclick="showHealthDetails()">Health Details</button>
                    <button onclick="exportDebugInfo()">Export Debug Info</button>
                </div>
                
                <div id="healthDetails" style="display: none; margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <h4>Detailed Health Information</h4>
                    <div id="healthDetailsContent"></div>
                </div>
            </section>

            <!-- Database Management Section -->
            <section class="test-section">
                <h2>üóÑÔ∏è Database Management</h2>
                <div class="stats-grid" id="dbStats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCards">-</div>
                        <div class="stat-label">Total Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="externalCards">-</div>
                        <div class="stat-label">External Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cachedCards">-</div>
                        <div class="stat-label">Cached Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lastSync">-</div>
                        <div class="stat-label">Last Sync</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="syncWithExternal()" class="primary">Sync with External DBs</button>
                    <button onclick="loadFromExternal()">Load External Cards</button>
                    <button onclick="loadEnhancedFallback()">Load Enhanced FFTCG Data</button>
                    <button onclick="preloadCardImages()">Preload Card Images</button>
                    <button onclick="clearCache()">Clear Cache</button>
                    <button onclick="exportData()">Export Data</button>
                </div>
                
                <div id="imageLoadingStatus" style="display: none; margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                    <h4>Image Loading Progress</h4>
                    <div id="imageProgress"></div>
                </div>
            </section>

            <!-- Card Search Section -->
            <section class="test-section">
                <h2>üîç Card Search & Browse</h2>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search for cards (e.g., 'Lightning', 'Opus', 'Shiva')">
                    <button onclick="searchCards()">Search</button>
                    <button onclick="searchExternal()">Search External</button>
                    <select id="setSelect" onchange="filterBySet()">
                        <option value="">All Sets</option>
                    </select>
                </div>
                
                <div id="cardResults" class="card-preview-grid">
                    <p>Use the search above to find cards from external databases.</p>
                </div>
            </section>

            <!-- Set Management Section -->
            <section class="test-section">
                <h2>üìö Set Management</h2>
                <div id="setsList">
                    <p>Loading available sets...</p>
                </div>
                
                <div class="controls">
                    <button onclick="loadAvailableSets()">Load Available Sets</button>
                    <button onclick="loadOpusSet('Opus I')">Load Opus I</button>
                    <button onclick="loadOpusSet('Opus XIII')">Load Opus XIII</button>
                    <button onclick="showAllOpusSets()">Show All 13 Sets</button>
                    <button onclick="testImageUrls()">Test Image URLs</button>
                </div>
            </section>

            <!-- Debug Log Section -->
            <section class="test-section">
                <h2>üìã Enhanced Debug Log</h2>
                <div class="controls">
                    <button onclick="clearLog()">Clear Log</button>
                    <button onclick="toggleAutoScroll()">Toggle Auto-scroll</button>
                    <button onclick="showAPILogs()">Show API Logs</button>
                    <button onclick="filterLogLevel('error')">Errors Only</button>
                    <button onclick="filterLogLevel('warn')">Warnings Only</button>
                    <button onclick="filterLogLevel('')">All Logs</button>
                </div>
                <div id="debugLog" class="log-output">
                    External database integration test started...<br>
                </div>
                
                <div id="apiDebugLog" style="display: none; margin-top: 20px;">
                    <h4>API Debug Logs</h4>
                    <div id="apiLogContent" class="log-output" style="max-height: 200px;"></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { externalCardAPI } from './js/data/ExternalCardAPI.js';
        import { CardDatabase } from './js/core/CardDatabase.js';
        import { logger } from './js/utils/Logger.js';

        // Global instances
        window.externalAPI = externalCardAPI;
        window.cardDB = new CardDatabase();
        window.testLogger = logger;

        let autoScroll = true;
        let searchResults = [];

        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const typeColors = {
                info: '#00ff00',
                warn: '#ffaa00',
                error: '#ff4444',
                success: '#44ff44'
            };
            
            logDiv.innerHTML += `<span style="color: ${typeColors[type] || '#00ff00'}">[${timestamp}] ${message}</span><br>`;
            
            if (autoScroll) {
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        // Enhanced API Status Check
        window.checkAPIStatus = async function() {
            log('Checking API status using health monitoring...', 'info');
            
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<div class="status-card unknown"><h3>Refreshing...</h3><p>Running health checks...</p></div>';
            
            try {
                // Force a health check
                await externalAPI.refreshHealthStatus();
                
                // Get health status
                const healthStatus = externalAPI.getHealthStatus();
                
                log(`Health check completed. ${healthStatus.summary.online}/${healthStatus.summary.total} APIs online`, 'info');
                
                statusDiv.innerHTML = '';
                
                if (healthStatus.apis && healthStatus.apis.length > 0) {
                    healthStatus.apis.forEach(api => {
                        const statusCard = document.createElement('div');
                        statusCard.className = `status-card ${api.isOnline ? 'online' : 'offline'}`;
                        
                        let statusText = api.isOnline ? '‚úÖ Online and accessible' : '‚ùå Offline or inaccessible';
                        let details = '';
                        
                        if (api.isOnline && api.responseTime) {
                            details = `<small>Response time: ${api.responseTime}ms</small>`;
                        } else if (!api.isOnline && api.error) {
                            details = `<small>Error: ${api.error}</small>`;
                        }
                        
                        statusCard.innerHTML = `
                            <h3>${api.name}</h3>
                            <p>${statusText}</p>
                            ${details}
                            <small>Last checked: ${new Date(api.lastChecked).toLocaleTimeString()}</small>
                        `;
                        
                        statusDiv.appendChild(statusCard);
                        
                        log(`${api.name} API: ${api.isOnline ? 'online' : 'offline'}`, 
                            api.isOnline ? 'success' : 'warn');
                    });
                } else {
                    statusDiv.innerHTML = '<div class="status-card unknown"><h3>No APIs</h3><p>No API status available</p></div>';
                }
                
            } catch (error) {
                log(`Error checking API status: ${error.message}`, 'error');
                statusDiv.innerHTML = `
                    <div class="status-card offline">
                        <h3>Error</h3>
                        <p>‚ùå Failed to check API status</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        };

        // Enhanced sync with external databases
        window.syncWithExternal = async function() {
            log('Starting enhanced sync with external databases...', 'info');
            
            try {
                // Clear API logs to track this sync session
                externalAPI.clearDebugLogs();
                
                log('Sync process started - check API logs for detailed progress', 'info');
                
                const result = await cardDB.syncWithExternal();
                
                if (result.success) {
                    log(`Sync successful: ${result.cardsAdded} cards added, ${result.totalCards} total`, 'success');
                    updateStats();
                    
                    // Show some API debug info
                    const apiLogs = externalAPI.getDebugLogs('info', 10);
                    log(`API operations completed: ${apiLogs.length} debug entries logged`, 'info');
                } else {
                    log(`Sync failed: ${result.error}`, 'error');
                    
                    // Show error logs for debugging
                    const errorLogs = externalAPI.getDebugLogs('error', 5);
                    if (errorLogs.length > 0) {
                        log(`Recent API errors: ${errorLogs.length} errors logged`, 'warn');
                    }
                }
            } catch (error) {
                log(`Sync error: ${error.message}`, 'error');
                
                // Export debug info on error
                log('Exporting debug information due to sync error...', 'info');
                setTimeout(() => exportDebugInfo(), 1000);
            }
        };

        // Enhanced load cards from external APIs
        window.loadFromExternal = async function() {
            log('Loading cards from external APIs with detailed tracking...', 'info');
            
            try {
                // Clear logs to track this operation
                externalAPI.clearDebugLogs();
                
                const startTime = Date.now();
                const success = await cardDB.loadFromExternalAPIs(true);
                const duration = Date.now() - startTime;
                
                if (success) {
                    log(`Successfully loaded cards from external APIs in ${duration}ms`, 'success');
                    updateStats();
                    
                    // Show operation summary
                    const debugLogs = externalAPI.getDebugLogs(null, 20);
                    log(`Operation completed with ${debugLogs.length} debug entries`, 'info');
                    
                    // Show breakdown by source
                    const healthStatus = externalAPI.getHealthStatus();
                    const onlineAPIs = healthStatus.apis.filter(api => api.isOnline).length;
                    log(`Used ${onlineAPIs} healthy APIs out of ${healthStatus.apis.length} total`, 'info');
                } else {
                    log('Failed to load cards from external APIs', 'error');
                    
                    // Show error details
                    const errorLogs = externalAPI.getDebugLogs('error');
                    if (errorLogs.length > 0) {
                        log(`${errorLogs.length} errors encountered during load`, 'warn');
                    }
                }
            } catch (error) {
                log(`Error loading external cards: ${error.message}`, 'error');
                
                // Auto-show debug info on errors
                setTimeout(() => {
                    showAPILogs();
                    log('Debug logs shown automatically due to error', 'info');
                }, 500);
            }
        };

        // Search cards
        window.searchCards = async function() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            log(`Searching local database for: "${query}"`, 'info');
            
            try {
                const results = cardDB.searchCards(query);
                displayCardResults(results, 'local');
                searchResults = results;
                log(`Found ${results.length} cards in local database`, 'success');
            } catch (error) {
                log(`Search error: ${error.message}`, 'error');
            }
        };

        // Search external APIs
        window.searchExternal = async function() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            log(`Searching external APIs for: "${query}"`, 'info');
            
            try {
                const results = await cardDB.searchExternal(query);
                displayCardResults(results, 'external');
                searchResults = results;
                log(`Found ${results.length} cards in external APIs`, 'success');
            } catch (error) {
                log(`External search error: ${error.message}`, 'error');
            }
        };

        // Display card results
        function displayCardResults(cards, source) {
            const resultsDiv = document.getElementById('cardResults');
            resultsDiv.innerHTML = '';
            
            if (cards.length === 0) {
                resultsDiv.innerHTML = '<p>No cards found matching your search.</p>';
                return;
            }

            cards.slice(0, 20).forEach(card => { // Limit to first 20 results
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-preview';
                
                cardDiv.innerHTML = `
                    <div class="card-image">
                        <img src="${card.image}" alt="${card.name}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'" />
                    </div>
                    <div class="card-info">
                        <h4>${card.name}</h4>
                        <div class="card-details">
                            <span class="source-badge source-${card.source || 'fallback'}">${card.source || 'fallback'}</span>
                            <br>
                            <strong>Element:</strong> ${card.element} | 
                            <strong>Type:</strong> ${card.type} | 
                            <strong>Cost:</strong> ${card.cost}
                            ${card.power ? ` | <strong>Power:</strong> ${card.power}` : ''}
                        </div>
                        <div class="card-details">
                            <strong>Set:</strong> ${card.set || 'Unknown'} | 
                            <strong>Rarity:</strong> ${card.rarity || 'C'}
                        </div>
                        ${card.text ? `<div class="card-details"><strong>Text:</strong> ${card.text.substring(0, 100)}${card.text.length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                `;
                
                resultsDiv.appendChild(cardDiv);
            });

            if (cards.length > 20) {
                const moreDiv = document.createElement('div');
                moreDiv.innerHTML = `<p>... and ${cards.length - 20} more cards. Refine your search to see more results.</p>`;
                resultsDiv.appendChild(moreDiv);
            }
        }

        // Load available sets
        window.loadAvailableSets = async function() {
            log('Loading available sets from external APIs...', 'info');
            
            try {
                const sets = await cardDB.getExternalSets();
                const setsDiv = document.getElementById('setsList');
                const setSelect = document.getElementById('setSelect');
                
                // Update sets list
                setsDiv.innerHTML = '<h4>Available Sets:</h4><ul>' + 
                    sets.map(set => `<li>${set}</li>`).join('') + 
                    '</ul>';
                
                // Update set selector
                setSelect.innerHTML = '<option value="">All Sets</option>' +
                    sets.map(set => `<option value="${set}">${set}</option>`).join('');
                
                log(`Loaded ${sets.length} available sets`, 'success');
            } catch (error) {
                log(`Error loading sets: ${error.message}`, 'error');
            }
        };

        // Load specific Opus set
        window.loadOpusSet = async function(setName) {
            log(`Loading ${setName} cards...`, 'info');
            
            try {
                const cards = await cardDB.getExternalCardsBySet(setName);
                displayCardResults(cards, 'external');
                log(`Loaded ${cards.length} cards from ${setName}`, 'success');
            } catch (error) {
                log(`Error loading ${setName}: ${error.message}`, 'error');
            }
        };

        // Filter by set
        window.filterBySet = function() {
            const setName = document.getElementById('setSelect').value;
            if (!setName) {
                displayCardResults(searchResults, 'filtered');
                return;
            }
            
            const filtered = searchResults.filter(card => 
                card.set && card.set.toLowerCase().includes(setName.toLowerCase())
            );
            
            displayCardResults(filtered, 'filtered');
            log(`Filtered to ${filtered.length} cards from ${setName}`, 'info');
        };

        // Update statistics
        function updateStats() {
            const stats = cardDB.getEnhancedStats();
            
            if (stats) {
                document.getElementById('totalCards').textContent = stats.totalCards || 0;
                document.getElementById('externalCards').textContent = stats.external?.cardsWithExternalData || 0;
                document.getElementById('cachedCards').textContent = stats.external?.apiStatus?.cachedCards || 0;
                
                const lastSync = stats.external?.lastSync;
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    document.getElementById('lastSync').textContent = syncDate.toLocaleDateString();
                } else {
                    document.getElementById('lastSync').textContent = 'Never';
                }
            }
        }

        // Utility functions
        window.refreshAPIs = async function() {
            log('Refreshing all APIs with health monitoring...', 'info');
            
            try {
                // Force health check
                await externalAPI.performHealthCheck();
                
                // Update UI
                await checkAPIStatus();
                loadAvailableSets();
                updateStats();
                
                // Show summary
                const healthStatus = externalAPI.getHealthStatus();
                log(`API refresh completed: ${healthStatus.summary.online}/${healthStatus.summary.total} APIs healthy`, 'success');
            } catch (error) {
                log(`Error refreshing APIs: ${error.message}`, 'error');
            }
        };

        window.clearCache = function() {
            cardDB.clearCache();
            externalAPI.clearDebugLogs();
            log('Cache and debug logs cleared', 'info');
            updateStats();
        };

        window.exportData = function() {
            const data = {
                stats: cardDB.getEnhancedStats(),
                apiStatus: externalAPI.getAPIStatus(),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fftcg-external-db-export-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Data exported successfully', 'success');
        };

        window.clearLog = function() {
            document.getElementById('debugLog').innerHTML = '';
        };

        window.toggleAutoScroll = function() {
            autoScroll = !autoScroll;
            log(`Auto-scroll ${autoScroll ? 'enabled' : 'disabled'}`, 'info');
        };

        // New debug and health monitoring functions
        window.showHealthDetails = function() {
            const healthDiv = document.getElementById('healthDetails');
            const contentDiv = document.getElementById('healthDetailsContent');
            
            if (healthDiv.style.display === 'none') {
                const healthStatus = externalAPI.getHealthStatus();
                const apiStatus = externalAPI.getAPIStatus();
                
                let html = `
                    <h5>Health Summary</h5>
                    <p>Total APIs: ${healthStatus.summary.total} | Online: ${healthStatus.summary.online} | Offline: ${healthStatus.summary.offline}</p>
                    <p>Last Check: ${healthStatus.lastCheck ? new Date(healthStatus.lastCheck).toLocaleString() : 'Never'}</p>
                    
                    <h5>CORS Configuration</h5>
                    <p>Proxy: ${apiStatus.corsProxy}</p>
                    
                    <h5>Recent Debug Logs</h5>
                    <div style="max-height: 150px; overflow-y: auto; background: #fff; padding: 10px; font-family: monospace; font-size: 12px;">
                `;
                
                const recentLogs = externalAPI.getDebugLogs(null, 20);
                recentLogs.forEach(log => {
                    html += `<div>[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}</div>`;
                });
                
                html += '</div>';
                
                contentDiv.innerHTML = html;
                healthDiv.style.display = 'block';
            } else {
                healthDiv.style.display = 'none';
            }
        };
        
        window.showAPILogs = function() {
            const apiLogDiv = document.getElementById('apiDebugLog');
            const contentDiv = document.getElementById('apiLogContent');
            
            if (apiLogDiv.style.display === 'none') {
                const logs = externalAPI.getDebugLogs(null, 50);
                
                let html = '';
                logs.forEach(log => {
                    const color = {
                        error: '#ff4444',
                        warn: '#ffaa00',
                        info: '#00ff00'
                    }[log.level] || '#00ff00';
                    
                    html += `<span style="color: ${color}">[${new Date(log.timestamp).toLocaleTimeString()}] ${log.level.toUpperCase()}: ${log.message}</span><br>`;
                });
                
                contentDiv.innerHTML = html || 'No API logs available';
                apiLogDiv.style.display = 'block';
            } else {
                apiLogDiv.style.display = 'none';
            }
        };
        
        window.filterLogLevel = function(level) {
            const logs = level ? externalAPI.getDebugLogs(level, 100) : externalAPI.getDebugLogs(null, 100);
            const contentDiv = document.getElementById('apiLogContent');
            
            let html = '';
            logs.forEach(log => {
                const color = {
                    error: '#ff4444',
                    warn: '#ffaa00',
                    info: '#00ff00'
                }[log.level] || '#00ff00';
                
                html += `<span style="color: ${color}">[${new Date(log.timestamp).toLocaleTimeString()}] ${log.level.toUpperCase()}: ${log.message}</span><br>`;
            });
            
            contentDiv.innerHTML = html || `No ${level || 'debug'} logs available`;
            
            if (html) {
                document.getElementById('apiDebugLog').style.display = 'block';
            }
            
            log(`Filtered logs to show: ${level || 'all levels'} (${logs.length} entries)`, 'info');
        };
        
        window.exportDebugInfo = function() {
            const debugInfo = externalAPI.exportDebugInfo();
            
            const blob = new Blob([JSON.stringify(debugInfo, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fftcg-debug-info-${new Date().toISOString().slice(0, 16).replace(':', '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Debug information exported successfully', 'success');
        };
        
        // Load enhanced fallback data into database
        window.loadEnhancedFallback = async function() {
            log('Loading enhanced FFTCG character data with all 13 Opus sets...', 'info');
            
            try {
                const enhancedData = externalAPI.generateEnhancedFallbackData();
                
                if (enhancedData && enhancedData.length > 0) {
                    const bySets = {};
                    enhancedData.forEach(card => {
                        bySets[card.set] = (bySets[card.set] || 0) + 1;
                    });
                    
                    log(`Loading ${enhancedData.length} enhanced FFTCG cards into database`, 'info');
                    log(`Opus sets available: ${Object.keys(bySets).sort().join(', ')}`, 'info');
                    log(`Total sets: ${Object.keys(bySets).length}/13`, 'success');
                    
                    updateStats();
                } else {
                    log('Failed to load enhanced data', 'error');
                }
            } catch (error) {
                log(`Error loading enhanced data: ${error.message}`, 'error');
            }
        };
        
        // Show all Opus sets
        window.showAllOpusSets = function() {
            log('Displaying all 13 Opus sets...', 'info');
            
            try {
                const enhancedData = externalAPI.generateEnhancedFallbackData();
                const setGroups = {};
                enhancedData.forEach(card => {
                    if (!setGroups[card.set]) {
                        setGroups[card.set] = [];
                    }
                    setGroups[card.set].push(card);
                });
                
                const resultsDiv = document.getElementById('cardResults');
                let html = '<h3>All 13 Opus Sets Available</h3>';
                
                Object.keys(setGroups).sort().forEach(setName => {
                    const setCards = setGroups[setName];
                    html += `
                        <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                            <h4>${setName} (${setCards.length} cards)</h4>
                            <p>Sample characters: ${setCards.slice(0, 5).map(c => c.name).join(', ')}${setCards.length > 5 ? '...' : ''}</p>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                log(`Generated ${Object.keys(setGroups).length} Opus sets with ${enhancedData.length} total cards`, 'success');
            } catch (error) {
                log(`Error displaying Opus sets: ${error.message}`, 'error');
            }
        };
        
        // Preload card images
        window.preloadCardImages = async function() {
            log('Starting card image preloading...', 'info');
            
            try {
                const enhancedData = externalAPI.generateEnhancedFallbackData();
                const sampleCards = enhancedData.slice(0, 10);
                
                const statusDiv = document.getElementById('imageLoadingStatus');
                const progressDiv = document.getElementById('imageProgress');
                statusDiv.style.display = 'block';
                progressDiv.innerHTML = 'Testing image URLs...';
                
                log(`Testing image URLs for ${sampleCards.length} sample cards...`, 'info');
                
                if (externalAPI.preloadCardImages) {
                    const result = await externalAPI.preloadCardImages(sampleCards, 3);
                    progressDiv.innerHTML = `
                        <p><strong>Image Test Complete!</strong></p>
                        <p>Working URLs: ${result.loaded}</p>
                        <p>Failed URLs: ${result.failed}</p>
                        <p>Success rate: ${Math.round((result.loaded / result.total) * 100)}%</p>
                    `;
                    log(`Image preloading completed: ${result.loaded}/${result.total} successful`, 'success');
                } else {
                    progressDiv.innerHTML = '<p>Image preloading function not available</p>';
                    log('Image preloading function not available', 'warn');
                }
                
                updateStats();
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                log(`Error preloading images: ${error.message}`, 'error');
                document.getElementById('imageLoadingStatus').style.display = 'none';
            }
        };
        
        // Test image URLs
        window.testImageUrls = async function() {
            log('Testing card image URL generation...', 'info');
            
            try {
                const enhancedData = externalAPI.generateEnhancedFallbackData();
                const testCard = enhancedData.find(card => card.name === 'Terra') || enhancedData[0];
                
                if (testCard && testCard.imageUrls) {
                    log(`Generated ${testCard.imageUrls.length} image URL patterns for ${testCard.name}:`, 'info');
                    
                    testCard.imageUrls.slice(0, 5).forEach((url, index) => {
                        log(`${index + 1}. ${url}`, 'info');
                    });
                    
                    displayCardResults([testCard], 'image-test');
                    log('Image URL test completed - check card display above', 'success');
                } else {
                    log('No test card with image URLs found', 'warn');
                }
            } catch (error) {
                log(`Error testing image URLs: ${error.message}`, 'error');
            }
        };
        
        // Initialize on page load
        setTimeout(() => {
            log('External database integration test initialized with enhanced monitoring', 'success');
            
            // Wait a moment for the API to initialize
            setTimeout(() => {
                checkAPIStatus();
                updateStats();
                loadAvailableSets();
                
                // Show enhanced data demo
                log('üí° Try "Load Enhanced FFTCG Data" to see all 13 Opus sets!', 'info');
                log('üá∫üá∏ Try "Show All 13 Sets" to see complete Opus coverage!', 'info');
            }, 2000);
        }, 1000);
    </script>
</body>
</html>