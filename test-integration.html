<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFTCG Simulator - Complete Integration Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/accessibility.css">
    <style>
        .test-suite {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
            color: #e0e0e0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warn {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .test-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #2196f3);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body style="background: #1a1a1a; color: #e0e0e0; margin: 0;">
    <div class="container" style="background: #1a1a1a; min-height: 100vh; color: #e0e0e0;">
        <header>
            <h1>üß™ FFTCG Simulator - Complete Integration Test</h1>
            <p>Comprehensive testing of all system components, databases, and functionality.</p>
        </header>

        <main>
            <!-- Test Controls -->
            <section class="test-suite">
                <h2>üéÆ Test Controls</h2>
                <div class="controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="runAllTests()" class="primary" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #2196f3; color: white; cursor: pointer;">Run All Tests</button>
                    <button onclick="runBasicTests()" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #4a4a4a; color: #e0e0e0; cursor: pointer;">Basic Component Tests</button>
                    <button onclick="runDatabaseTests()" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #4a4a4a; color: #e0e0e0; cursor: pointer;">Database Tests</button>
                    <button onclick="runImageTests()" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #4a4a4a; color: #e0e0e0; cursor: pointer;">Image System Tests</button>
                    <button onclick="runAccessibilityTests()" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #4a4a4a; color: #e0e0e0; cursor: pointer;">Accessibility Tests</button>
                    <button onclick="clearResults()" style="padding: 10px 20px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #4a4a4a; color: #e0e0e0; cursor: pointer;">Clear Results</button>
                </div>
            </section>

            <!-- Test Statistics -->
            <section class="test-suite">
                <h2>üìä Test Statistics</h2>
                <div class="test-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalTests">0</div>
                        <div>Total Tests</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="passedTests">0</div>
                        <div>Passed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="failedTests">0</div>
                        <div>Failed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="testProgress">0%</div>
                        <div>Progress</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
            </section>

            <!-- Test Results -->
            <section class="test-suite">
                <h2>üîç Test Results</h2>
                <div id="testResults">
                    <p>Click "Run All Tests" to start comprehensive testing.</p>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        // Import required modules
        import { externalCardAPI } from './js/data/ExternalCardAPI.js';
        import { CardDatabase } from './js/core/CardDatabase.js';
        import { accessibilitySettings } from './js/utils/AccessibilitySettings.js';
        import { notifications } from './js/utils/Notifications.js';
        import { logger } from './js/utils/Logger.js';

        // Global test state
        let testResults = [];
        let currentTestIndex = 0;
        let totalTests = 0;

        // Initialize components
        const cardDB = new CardDatabase();
        
        // Make components available globally
        window.externalCardAPI = externalCardAPI;
        window.cardDB = cardDB;
        window.accessibilitySettings = accessibilitySettings;
        window.notifications = notifications;

        // Test framework functions
        function logTest(name, result, message, details = null) {
            const test = {
                name,
                result, // 'pass', 'fail', 'warn', 'info'
                message,
                details,
                timestamp: new Date().toLocaleTimeString()
            };
            
            testResults.push(test);
            
            const resultsDiv = document.getElementById('testResults');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result test-${result}`;
            testDiv.innerHTML = `
                <strong>[${test.timestamp}] ${name}:</strong> ${message}
                ${details ? `<br><small>Details: ${details}</small>` : ''}
            `;
            resultsDiv.appendChild(testDiv);
            
            updateTestStats();
        }

        function updateTestStats() {
            const total = testResults.length;
            const passed = testResults.filter(t => t.result === 'pass').length;
            const failed = testResults.filter(t => t.result === 'fail').length;
            const progress = totalTests > 0 ? Math.round((total / totalTests) * 100) : 0;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('testProgress').textContent = `${progress}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // Basic Component Tests
        async function runBasicTests() {
            logTest('Component Loading', 'info', 'Testing basic component availability...');
            
            try {
                // Test ExternalCardAPI
                if (typeof externalCardAPI !== 'undefined' && externalCardAPI.getAPIStatus) {
                    logTest('ExternalCardAPI', 'pass', 'Successfully loaded and accessible');
                } else {
                    logTest('ExternalCardAPI', 'fail', 'Not loaded or missing methods');
                }
                
                // Test CardDatabase
                if (typeof cardDB !== 'undefined' && cardDB.initialize) {
                    await cardDB.initialize();
                    logTest('CardDatabase', 'pass', 'Successfully initialized');
                } else {
                    logTest('CardDatabase', 'fail', 'Not loaded or missing methods');
                }
                
                // Test AccessibilitySettings
                if (typeof accessibilitySettings !== 'undefined' && accessibilitySettings.getSettings) {
                    const settings = accessibilitySettings.getSettings();
                    logTest('AccessibilitySettings', 'pass', `Loaded with ${Object.keys(settings).length} settings`);
                } else {
                    logTest('AccessibilitySettings', 'fail', 'Not loaded or missing methods');
                }
                
                // Test Notifications
                if (typeof notifications !== 'undefined' && notifications.initialize) {
                    notifications.initialize();
                    logTest('Notifications', 'pass', 'Successfully initialized');
                } else {
                    logTest('Notifications', 'fail', 'Not loaded or missing methods');
                }
                
            } catch (error) {
                logTest('Basic Components', 'fail', `Error during basic tests: ${error.message}`);
            }
        }

        // Database Tests
        async function runDatabaseTests() {
            logTest('Database Testing', 'info', 'Testing database functionality...');
            
            try {
                // Test enhanced card generation
                const enhancedCards = externalCardAPI.generateEnhancedFallbackData();
                if (enhancedCards && enhancedCards.length > 0) {
                    logTest('Enhanced Card Generation', 'pass', `Generated ${enhancedCards.length} cards`);
                    
                    // Test set coverage
                    const sets = [...new Set(enhancedCards.map(c => c.set))];
                    if (sets.length >= 13) {
                        logTest('Set Coverage', 'pass', `All ${sets.length} Opus sets available`);
                    } else {
                        logTest('Set Coverage', 'warn', `Only ${sets.length} sets found, expected 13`);
                    }
                    
                    // Test card structure
                    const sampleCard = enhancedCards[0];
                    const requiredFields = ['id', 'name', 'element', 'type', 'cost', 'set'];
                    const hasAllFields = requiredFields.every(field => sampleCard.hasOwnProperty(field));
                    
                    if (hasAllFields) {
                        logTest('Card Structure', 'pass', 'Cards have all required fields');
                    } else {
                        const missing = requiredFields.filter(field => !sampleCard.hasOwnProperty(field));
                        logTest('Card Structure', 'fail', `Missing fields: ${missing.join(', ')}`);
                    }
                    
                } else {
                    logTest('Enhanced Card Generation', 'fail', 'No cards generated');
                }
                
                // Test API status
                const apiStatus = externalCardAPI.getAPIStatus();
                if (apiStatus) {
                    logTest('API Status', 'pass', `API status available with ${apiStatus.availableSources.length} sources`);
                } else {
                    logTest('API Status', 'fail', 'API status not available');
                }
                
            } catch (error) {
                logTest('Database Tests', 'fail', `Database test error: ${error.message}`);
            }
        }

        // Image System Tests
        async function runImageTests() {
            logTest('Image System Testing', 'info', 'Testing image handling and caching...');
            
            try {
                // Test image cache initialization
                const imageCacheStats = externalCardAPI.getImageCacheStats ? externalCardAPI.getImageCacheStats() : null;
                if (imageCacheStats) {
                    logTest('Image Cache', 'pass', `Image cache initialized with ${imageCacheStats.totalCached} cached items`);
                } else {
                    logTest('Image Cache', 'warn', 'Image cache statistics not available');
                }
                
                // Test image URL generation
                const enhancedCards = externalCardAPI.generateEnhancedFallbackData();
                if (enhancedCards.length > 0) {
                    const testCard = enhancedCards[0];
                    
                    if (testCard.imageUrls && testCard.imageUrls.length > 0) {
                        logTest('Image URL Generation', 'pass', `Generated ${testCard.imageUrls.length} image URLs for test card`);
                    } else {
                        logTest('Image URL Generation', 'fail', 'No image URLs generated for test card');
                    }
                    
                    if (testCard.image) {
                        logTest('Primary Image URL', 'pass', 'Primary image URL assigned');
                    } else {
                        logTest('Primary Image URL', 'fail', 'No primary image URL');
                    }
                }
                
            } catch (error) {
                logTest('Image System Tests', 'fail', `Image test error: ${error.message}`);
            }
        }

        // Accessibility Tests
        async function runAccessibilityTests() {
            logTest('Accessibility Testing', 'info', 'Testing accessibility features...');
            
            try {
                // Test accessibility settings
                const settings = accessibilitySettings.getSettings();
                if (settings) {
                    logTest('Accessibility Settings', 'pass', `${Object.keys(settings).length} accessibility options available`);
                    
                    // Test specific settings
                    if (settings.hasOwnProperty('colorBlindMode')) {
                        logTest('Color Blind Support', 'pass', 'Color blind mode setting available');
                    } else {
                        logTest('Color Blind Support', 'fail', 'Color blind mode not found');
                    }
                    
                    if (settings.hasOwnProperty('highContrast')) {
                        logTest('High Contrast', 'pass', 'High contrast setting available');
                    } else {
                        logTest('High Contrast', 'fail', 'High contrast setting not found');
                    }
                }
                
                // Test notifications accessibility
                const testNotification = () => {
                    try {
                        notifications.info('Test accessibility notification');
                        return true;
                    } catch {
                        return false;
                    }
                };
                
                if (testNotification()) {
                    logTest('Accessible Notifications', 'pass', 'Notifications system working');
                } else {
                    logTest('Accessible Notifications', 'fail', 'Notifications system failed');
                }
                
            } catch (error) {
                logTest('Accessibility Tests', 'fail', `Accessibility test error: ${error.message}`);
            }
        }

        // Main test runner
        async function runAllTests() {
            // Clear previous results
            clearResults();
            
            // Estimate total tests
            totalTests = 15; // Approximate number of tests
            
            logTest('Integration Test', 'info', 'Starting comprehensive integration test suite...');
            
            try {
                await runBasicTests();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                
                await runDatabaseTests();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runImageTests();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runAccessibilityTests();
                
                // Final summary
                const passed = testResults.filter(t => t.result === 'pass').length;
                const failed = testResults.filter(t => t.result === 'fail').length;
                const warned = testResults.filter(t => t.result === 'warn').length;
                
                if (failed === 0) {
                    logTest('INTEGRATION TEST COMPLETE', 'pass', `All critical tests passed! (${passed} pass, ${warned} warnings)`);
                } else {
                    logTest('INTEGRATION TEST COMPLETE', 'fail', `${failed} tests failed, ${passed} passed, ${warned} warnings`);
                }
                
            } catch (error) {
                logTest('Integration Test', 'fail', `Test suite error: ${error.message}`);
            }
        }

        function clearResults() {
            testResults = [];
            currentTestIndex = 0;
            document.getElementById('testResults').innerHTML = '<p>Test results will appear here...</p>';
            updateTestStats();
        }

        // Make functions available globally
        window.runAllTests = runAllTests;
        window.runBasicTests = runBasicTests;
        window.runDatabaseTests = runDatabaseTests;
        window.runImageTests = runImageTests;
        window.runAccessibilityTests = runAccessibilityTests;
        window.clearResults = clearResults;

        // Auto-initialize
        setTimeout(() => {
            logTest('Integration Test Suite', 'info', 'Test suite ready. Click "Run All Tests" to begin.');
        }, 1000);
    </script>
</body>
</html>