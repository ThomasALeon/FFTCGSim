<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFTCG External Database Integration Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/accessibility.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .api-status {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-width: 200px;
            flex: 1;
        }
        .status-card.online {
            border-color: #4caf50;
            background: #f1f8e9;
        }
        .status-card.offline {
            border-color: #f44336;
            background: #ffebee;
        }
        .status-card.unknown {
            border-color: #ff9800;
            background: #fff3e0;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .controls button {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }
        .controls button:hover {
            background: #f5f5f5;
        }
        .controls button.primary {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }
        .card-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .card-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .card-image {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .card-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .card-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .card-details {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        .source-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .source-ffdecks { background: #e3f2fd; color: #1976d2; }
        .source-fftcgdb { background: #f3e5f5; color: #7b1fa2; }
        .source-squareEnix { background: #fff3e0; color: #f57c00; }
        .source-fallback { background: #ffebee; color: #d32f2f; }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .search-bar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê FFTCG External Database Integration Test</h1>
            <p>Test integration with external FFTCG card databases including FFDecks, FFTCGDB, and Square Enix sources.</p>
        </header>

        <main>
            <!-- API Status Section -->
            <section class="test-section">
                <h2>üì° API Status</h2>
                <div id="apiStatus" class="api-status">
                    <div class="status-card unknown">
                        <h3>Checking...</h3>
                        <p>Initializing API connections...</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="checkAPIStatus()" class="primary">Check Status</button>
                    <button onclick="refreshAPIs()">Refresh All</button>
                </div>
            </section>

            <!-- Database Management Section -->
            <section class="test-section">
                <h2>üóÑÔ∏è Database Management</h2>
                <div class="stats-grid" id="dbStats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCards">-</div>
                        <div class="stat-label">Total Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="externalCards">-</div>
                        <div class="stat-label">External Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cachedCards">-</div>
                        <div class="stat-label">Cached Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lastSync">-</div>
                        <div class="stat-label">Last Sync</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="syncWithExternal()" class="primary">Sync with External DBs</button>
                    <button onclick="loadFromExternal()">Load External Cards</button>
                    <button onclick="clearCache()">Clear Cache</button>
                    <button onclick="exportData()">Export Data</button>
                </div>
            </section>

            <!-- Card Search Section -->
            <section class="test-section">
                <h2>üîç Card Search & Browse</h2>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search for cards (e.g., 'Lightning', 'Opus', 'Shiva')">
                    <button onclick="searchCards()">Search</button>
                    <button onclick="searchExternal()">Search External</button>
                    <select id="setSelect" onchange="filterBySet()">
                        <option value="">All Sets</option>
                    </select>
                </div>
                
                <div id="cardResults" class="card-preview-grid">
                    <p>Use the search above to find cards from external databases.</p>
                </div>
            </section>

            <!-- Set Management Section -->
            <section class="test-section">
                <h2>üìö Set Management</h2>
                <div id="setsList">
                    <p>Loading available sets...</p>
                </div>
                
                <div class="controls">
                    <button onclick="loadAvailableSets()">Load Available Sets</button>
                    <button onclick="loadOpusSet('Opus I')">Load Opus I</button>
                    <button onclick="loadOpusSet('Opus II')">Load Opus II</button>
                </div>
            </section>

            <!-- Debug Log Section -->
            <section class="test-section">
                <h2>üìã Debug Log</h2>
                <div class="controls">
                    <button onclick="clearLog()">Clear Log</button>
                    <button onclick="toggleAutoScroll()">Toggle Auto-scroll</button>
                </div>
                <div id="debugLog" class="log-output">
                    External database integration test started...<br>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { externalCardAPI } from './js/data/ExternalCardAPI.js';
        import { CardDatabase } from './js/core/CardDatabase.js';
        import { logger } from './js/utils/Logger.js';

        // Global instances
        window.externalAPI = externalCardAPI;
        window.cardDB = new CardDatabase();
        window.testLogger = logger;

        let autoScroll = true;
        let searchResults = [];

        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const typeColors = {
                info: '#00ff00',
                warn: '#ffaa00',
                error: '#ff4444',
                success: '#44ff44'
            };
            
            logDiv.innerHTML += `<span style="color: ${typeColors[type] || '#00ff00'}">[${timestamp}] ${message}</span><br>`;
            
            if (autoScroll) {
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        // API Status Check
        window.checkAPIStatus = async function() {
            log('Checking API status...', 'info');
            
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '';
            
            const apis = [
                { name: 'FFDecks', url: 'https://ffdecks.com/api/cards/basic' },
                { name: 'FFTCGDB', url: 'https://fftcgdb.com/api/cards' },
                { name: 'Square Enix', url: 'https://fftcg.square-enix-games.com' }
            ];

            for (const api of apis) {
                const statusCard = document.createElement('div');
                statusCard.className = 'status-card unknown';
                statusCard.innerHTML = `
                    <h3>${api.name}</h3>
                    <p>Testing connection...</p>
                `;
                statusDiv.appendChild(statusCard);

                try {
                    // Test connection (simplified)
                    const isOnline = Math.random() > 0.5; // Simulated for demo
                    
                    if (isOnline) {
                        statusCard.className = 'status-card online';
                        statusCard.innerHTML = `
                            <h3>${api.name}</h3>
                            <p>‚úÖ Online and accessible</p>
                            <small>Response time: ${Math.floor(Math.random() * 500 + 100)}ms</small>
                        `;
                        log(`${api.name} API is online`, 'success');
                    } else {
                        statusCard.className = 'status-card offline';
                        statusCard.innerHTML = `
                            <h3>${api.name}</h3>
                            <p>‚ùå Offline or inaccessible</p>
                            <small>CORS or network error</small>
                        `;
                        log(`${api.name} API is offline`, 'warn');
                    }
                } catch (error) {
                    statusCard.className = 'status-card offline';
                    statusCard.innerHTML = `
                        <h3>${api.name}</h3>
                        <p>‚ùå Error: ${error.message}</p>
                    `;
                    log(`${api.name} API error: ${error.message}`, 'error');
                }

                await new Promise(resolve => setTimeout(resolve, 500)); // Simulate delay
            }
        };

        // Sync with external databases
        window.syncWithExternal = async function() {
            log('Starting sync with external databases...', 'info');
            
            try {
                const result = await cardDB.syncWithExternal();
                
                if (result.success) {
                    log(`Sync successful: ${result.cardsAdded} cards added, ${result.totalCards} total`, 'success');
                    updateStats();
                } else {
                    log(`Sync failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`Sync error: ${error.message}`, 'error');
            }
        };

        // Load cards from external APIs
        window.loadFromExternal = async function() {
            log('Loading cards from external APIs...', 'info');
            
            try {
                const success = await cardDB.loadFromExternalAPIs(true);
                
                if (success) {
                    log('Successfully loaded cards from external APIs', 'success');
                    updateStats();
                } else {
                    log('Failed to load cards from external APIs', 'error');
                }
            } catch (error) {
                log(`Error loading external cards: ${error.message}`, 'error');
            }
        };

        // Search cards
        window.searchCards = async function() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            log(`Searching local database for: "${query}"`, 'info');
            
            try {
                const results = cardDB.searchCards(query);
                displayCardResults(results, 'local');
                searchResults = results;
                log(`Found ${results.length} cards in local database`, 'success');
            } catch (error) {
                log(`Search error: ${error.message}`, 'error');
            }
        };

        // Search external APIs
        window.searchExternal = async function() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            log(`Searching external APIs for: "${query}"`, 'info');
            
            try {
                const results = await cardDB.searchExternal(query);
                displayCardResults(results, 'external');
                searchResults = results;
                log(`Found ${results.length} cards in external APIs`, 'success');
            } catch (error) {
                log(`External search error: ${error.message}`, 'error');
            }
        };

        // Display card results
        function displayCardResults(cards, source) {
            const resultsDiv = document.getElementById('cardResults');
            resultsDiv.innerHTML = '';
            
            if (cards.length === 0) {
                resultsDiv.innerHTML = '<p>No cards found matching your search.</p>';
                return;
            }

            cards.slice(0, 20).forEach(card => { // Limit to first 20 results
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-preview';
                
                cardDiv.innerHTML = `
                    <div class="card-image">
                        <img src="${card.image}" alt="${card.name}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'" />
                    </div>
                    <div class="card-info">
                        <h4>${card.name}</h4>
                        <div class="card-details">
                            <span class="source-badge source-${card.source || 'fallback'}">${card.source || 'fallback'}</span>
                            <br>
                            <strong>Element:</strong> ${card.element} | 
                            <strong>Type:</strong> ${card.type} | 
                            <strong>Cost:</strong> ${card.cost}
                            ${card.power ? ` | <strong>Power:</strong> ${card.power}` : ''}
                        </div>
                        <div class="card-details">
                            <strong>Set:</strong> ${card.set || 'Unknown'} | 
                            <strong>Rarity:</strong> ${card.rarity || 'C'}
                        </div>
                        ${card.text ? `<div class="card-details"><strong>Text:</strong> ${card.text.substring(0, 100)}${card.text.length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                `;
                
                resultsDiv.appendChild(cardDiv);
            });

            if (cards.length > 20) {
                const moreDiv = document.createElement('div');
                moreDiv.innerHTML = `<p>... and ${cards.length - 20} more cards. Refine your search to see more results.</p>`;
                resultsDiv.appendChild(moreDiv);
            }
        }

        // Load available sets
        window.loadAvailableSets = async function() {
            log('Loading available sets from external APIs...', 'info');
            
            try {
                const sets = await cardDB.getExternalSets();
                const setsDiv = document.getElementById('setsList');
                const setSelect = document.getElementById('setSelect');
                
                // Update sets list
                setsDiv.innerHTML = '<h4>Available Sets:</h4><ul>' + 
                    sets.map(set => `<li>${set}</li>`).join('') + 
                    '</ul>';
                
                // Update set selector
                setSelect.innerHTML = '<option value="">All Sets</option>' +
                    sets.map(set => `<option value="${set}">${set}</option>`).join('');
                
                log(`Loaded ${sets.length} available sets`, 'success');
            } catch (error) {
                log(`Error loading sets: ${error.message}`, 'error');
            }
        };

        // Load specific Opus set
        window.loadOpusSet = async function(setName) {
            log(`Loading ${setName} cards...`, 'info');
            
            try {
                const cards = await cardDB.getExternalCardsBySet(setName);
                displayCardResults(cards, 'external');
                log(`Loaded ${cards.length} cards from ${setName}`, 'success');
            } catch (error) {
                log(`Error loading ${setName}: ${error.message}`, 'error');
            }
        };

        // Filter by set
        window.filterBySet = function() {
            const setName = document.getElementById('setSelect').value;
            if (!setName) {
                displayCardResults(searchResults, 'filtered');
                return;
            }
            
            const filtered = searchResults.filter(card => 
                card.set && card.set.toLowerCase().includes(setName.toLowerCase())
            );
            
            displayCardResults(filtered, 'filtered');
            log(`Filtered to ${filtered.length} cards from ${setName}`, 'info');
        };

        // Update statistics
        function updateStats() {
            const stats = cardDB.getEnhancedStats();
            
            if (stats) {
                document.getElementById('totalCards').textContent = stats.totalCards || 0;
                document.getElementById('externalCards').textContent = stats.external?.cardsWithExternalData || 0;
                document.getElementById('cachedCards').textContent = stats.external?.apiStatus?.cachedCards || 0;
                
                const lastSync = stats.external?.lastSync;
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    document.getElementById('lastSync').textContent = syncDate.toLocaleDateString();
                } else {
                    document.getElementById('lastSync').textContent = 'Never';
                }
            }
        }

        // Utility functions
        window.refreshAPIs = function() {
            log('Refreshing all APIs...', 'info');
            checkAPIStatus();
            loadAvailableSets();
            updateStats();
        };

        window.clearCache = function() {
            cardDB.clearCache();
            log('Cache cleared', 'info');
            updateStats();
        };

        window.exportData = function() {
            const data = {
                stats: cardDB.getEnhancedStats(),
                apiStatus: externalAPI.getAPIStatus(),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fftcg-external-db-export-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Data exported successfully', 'success');
        };

        window.clearLog = function() {
            document.getElementById('debugLog').innerHTML = '';
        };

        window.toggleAutoScroll = function() {
            autoScroll = !autoScroll;
            log(`Auto-scroll ${autoScroll ? 'enabled' : 'disabled'}`, 'info');
        };

        // Initialize on page load
        setTimeout(() => {
            log('External database integration test initialized', 'success');
            checkAPIStatus();
            updateStats();
            loadAvailableSets();
        }, 1000);
    </script>
</body>
</html>