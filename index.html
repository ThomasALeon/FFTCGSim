<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Fantasy Trading Card Game Simulator</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <!-- Component CSS files -->
    <link rel="stylesheet" href="assets/css/components/modals.css">
    <link rel="stylesheet" href="assets/css/components/deck-builder.css">
    <link rel="stylesheet" href="assets/css/components/lobby.css">
    <link rel="stylesheet" href="assets/css/components/game-board.css">
    <link rel="stylesheet" href="assets/css/components/hotkey-help.css">
    <link rel="stylesheet" href="assets/css/accessibility.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Application Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">‚ö°</div>
            <div class="loading-text">Loading Final Fantasy TCG Simulator...</div>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container hidden">
        <!-- Navigation Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="title-icon">‚ö°</span>
                    Final Fantasy TCG Simulator
                </h1>
                <nav class="header-nav">
                    <button class="nav-btn" id="homeBtn" data-view="home">Home</button>
                    <button class="nav-btn" id="gameBtn" data-view="game" disabled>Game</button>
                    <button class="nav-btn" id="deckBuilderBtn" data-view="deck-builder">Deck Builder</button>
                    <button class="nav-btn" id="profileBtn" data-view="profile">Profile</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="app-main">
            <!-- Home View -->
            <section id="homeView" class="view active">
                <!-- User Profile Section -->
                <div class="profile-section">
                    <div class="profile-card">
                        <div class="profile-avatar" id="profileAvatar">‚ö°</div>
                        <div class="profile-info">
                            <h3 class="profile-name" id="profileName">Guest Player</h3>
                            <p class="profile-stats" id="profileStats">Games: 0 | Wins: 0 | Win Rate: 0%</p>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('profileModal')">
                            Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Main Menu Grid -->
                <div class="menu-grid">
                    <!-- Multiplayer Lobby -->
                    <div class="menu-card" onclick="openModal('lobbyModal')">
                        <div class="menu-icon">üåê</div>
                        <h3 class="menu-title">Multiplayer</h3>
                        <p class="menu-description">
                            Join or create game rooms to play against other players worldwide.
                        </p>
                        <div class="menu-stats">
                            <span id="onlineCount">0</span> players online
                        </div>
                    </div>

                    <!-- Deck Builder -->
                    <div class="menu-card" onclick="window.app.switchView('deck-builder')">
                        <div class="menu-icon">üìö</div>
                        <h3 class="menu-title">Deck Builder</h3>
                        <p class="menu-description">
                            Create and manage your card decks with our comprehensive database.
                        </p>
                        <div class="menu-stats">
                            <span id="deckCount">0</span> decks saved
                        </div>
                    </div>

                    <!-- Practice vs AI -->
                    <div class="menu-card" onclick="window.app.switchView('practice-lobby')">
                        <div class="menu-icon">ü§ñ</div>
                        <h3 class="menu-title">Practice vs AI</h3>
                        <p class="menu-description">
                            Test your decks against AI opponents of varying difficulty levels.
                        </p>
                        <div class="menu-stats">
                            Ready to Play
                        </div>
                    </div>

                    <!-- Tournament -->
                    <div class="menu-card" onclick="openModal('tournamentModal')">
                        <div class="menu-icon">üèÜ</div>
                        <h3 class="menu-title">Tournament</h3>
                        <p class="menu-description">
                            Participate in structured tournaments and climb the rankings.
                        </p>
                        <div class="menu-stats">
                            No active tournaments
                        </div>
                    </div>

                    <!-- Game Rules -->
                    <div class="menu-card" onclick="openModal('rulesModal')">
                        <div class="menu-icon">üìã</div>
                        <h3 class="menu-title">Game Rules</h3>
                        <p class="menu-description">
                            Learn the comprehensive rules and mechanics of Final Fantasy TCG.
                        </p>
                    </div>

                    <!-- Settings -->
                    <div class="menu-card" onclick="openModal('settingsModal')">
                        <div class="menu-icon">‚öôÔ∏è</div>
                        <h3 class="menu-title">Settings</h3>
                        <p class="menu-description">
                            Customize your experience with accessibility and preference options.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Deck Builder View -->
            <section id="deck-builderView" class="view">
                <div class="deck-builder-container">
                    
                    <!-- Deck Manager - Main Interface -->
                    <div class="deck-manager" id="deckManager">
                        <div class="deck-manager-header">
                            <h2>My Decks</h2>
                            <div class="deck-manager-actions">
                                <button class="btn btn-secondary" onclick="window.importDeck()" title="Import deck from text">
                                    üì• Import Deck
                                </button>
                                <button class="btn btn-primary" onclick="
                                    if (window.app && window.app.deckBuilder) {
                                        window.app.deckBuilder.showCreateNewDeck();
                                    } else {
                                        console.error('App or deck builder not available:', {app: !!window.app, deckBuilder: !!window.app?.deckBuilder});
                                        alert('Deck builder is still loading. Please wait a moment and try again.');
                                    }
                                ">
                                    + New Deck
                                </button>
                            </div>
                        </div>
                        
                        <div class="deck-list-container" id="deckListContainer">
                            <!-- Deck list will be populated here -->
                            <div class="no-decks-placeholder" id="noDecksPlaceholder">
                                <div class="placeholder-content">
                                    <div class="placeholder-icon">üé¥</div>
                                    <h3>No Decks Created</h3>
                                    <p>Create your first deck to get started building and playing!</p>
                                    <button class="btn btn-primary btn-large" onclick="
                                        if (window.app && window.app.deckBuilder) {
                                            window.app.deckBuilder.showCreateNewDeck();
                                        } else {
                                            console.error('App or deck builder not available:', {app: !!window.app, deckBuilder: !!window.app?.deckBuilder});
                                            alert('Deck builder is still loading. Please wait a moment and try again.');
                                        }
                                    ">
                                        Create Your First Deck
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deck Editor - Hidden by default -->
                    <div class="deck-editor" id="deckEditor" style="display: none;">
                        <div class="deck-editor-header">
                            <button class="btn btn-secondary" onclick="window.app?.deckBuilder?.exitDeckEditor()">
                                ‚Üê Back to Decks
                            </button>
                            <div class="deck-info">
                                <input type="text" id="deckName" placeholder="Deck Name" class="deck-name-input">
                                <span class="deck-count"><span id="deckCardCount">0</span>/50 cards</span>
                            </div>
                            <div class="deck-actions">
                                <button class="btn btn-secondary" onclick="window.importDeck()" title="Import deck from text">
                                    üì• Import
                                </button>
                                <button class="btn btn-secondary" onclick="window.exportDeck()" title="Export deck as text">
                                    üì§ Export
                                </button>
                                <button class="btn btn-primary" onclick="window.app?.deckBuilder?.saveDeck()" id="saveDeckBtn" disabled>Save Deck</button>
                            </div>
                        </div>
                        
                        <div class="deck-editor-content">
                            <!-- Persistent Edge Bars -->
                            <div class="edge-toggle-bar left-edge" id="leftEdgeBar" onclick="toggleSearchSidebar()" style="display: none;">
                                <div class="edge-handle">
                                    <span class="edge-icon">üîç</span>
                                    <span class="edge-text">Search</span>
                                </div>
                            </div>
                            <div class="edge-toggle-bar right-edge" id="rightEdgeBar" onclick="toggleDeckSidebar()" style="display: none;">
                                <div class="edge-handle">
                                    <span class="edge-text">Deck</span>
                                    <span class="edge-icon">üìö</span>
                                </div>
                            </div>

                            <!-- Search/Filter Sidebar - Left Side -->
                            <div class="search-filter-sidebar" id="searchFilterSidebar">
                                <div class="sidebar-toggle-bar left-toggle" onclick="toggleSearchSidebar()">
                                    <div class="toggle-handle">
                                        <span class="toggle-icon">üîç</span>
                                        <span class="toggle-text">Search & Filters</span>
                                        <span class="toggle-arrow">‚óÄ</span>
                                    </div>
                                </div>
                                <div class="sidebar-content">
                                    <div class="sidebar-header">
                                        <h3>Search & Filter</h3>
                                        <button class="sidebar-close-btn" onclick="toggleSearchSidebar()">‚úï</button>
                                    </div>
                                    
                                    <!-- Search Input -->
                                    <div class="search-section">
                                        <div class="search-input-container">
                                            <input type="text" id="cardSearch" placeholder="Search cards by name..." class="search-input">
                                            <button class="search-clear-btn" id="clearSearch" style="display: none;" onclick="window.app?.deckBuilder?.clearSearch()">‚úï</button>
                                        </div>
                                    </div>

                                    <!-- Sort Options -->
                                    <div class="sort-section">
                                        <label class="sort-label">Sort by:</label>
                                        <select id="sortSelect" class="sort-select" onchange="window.app?.deckBuilder?.setSortOption(this.value)">
                                            <option value="name-asc">Name (A-Z)</option>
                                            <option value="name-desc">Name (Z-A)</option>
                                            <option value="id-asc">ID (Ascending)</option>
                                            <option value="id-desc">ID (Descending)</option>
                                            <option value="cost-asc">Cost (Low to High)</option>
                                            <option value="cost-desc">Cost (High to Low)</option>
                                            <option value="category-asc">Category (A-Z)</option>
                                            <option value="category-desc">Category (Z-A)</option>
                                        </select>
                                    </div>

                                    <!-- Filter Controls -->
                                    <div class="filter-controls">
                                        <!-- Element Filter Buttons -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Element:</label>
                                            <div class="filter-buttons" id="elementButtons">
                                                <button class="filter-btn active" data-element="" onclick="window.app?.deckBuilder?.setElementFilter('')">All</button>
                                                <button class="filter-btn element-fire" data-element="fire" onclick="window.app?.deckBuilder?.setElementFilter('fire')">
                                                    <span class="filter-icon">üî•</span><span class="filter-text">Fire</span>
                                                </button>
                                                <button class="filter-btn element-ice" data-element="ice" onclick="window.app?.deckBuilder?.setElementFilter('ice')">
                                                    <span class="filter-icon">‚ùÑÔ∏è</span><span class="filter-text">Ice</span>
                                                </button>
                                                <button class="filter-btn element-wind" data-element="wind" onclick="window.app?.deckBuilder?.setElementFilter('wind')">
                                                    <span class="filter-icon">üå™Ô∏è</span><span class="filter-text">Wind</span>
                                                </button>
                                                <button class="filter-btn element-lightning" data-element="lightning" onclick="window.app?.deckBuilder?.setElementFilter('lightning')">
                                                    <span class="filter-icon">‚ö°</span><span class="filter-text">Lightning</span>
                                                </button>
                                                <button class="filter-btn element-water" data-element="water" onclick="window.app?.deckBuilder?.setElementFilter('water')">
                                                    <span class="filter-icon">üíß</span><span class="filter-text">Water</span>
                                                </button>
                                                <button class="filter-btn element-earth" data-element="earth" onclick="window.app?.deckBuilder?.setElementFilter('earth')">
                                                    <span class="filter-icon">üåç</span><span class="filter-text">Earth</span>
                                                </button>
                                                <button class="filter-btn element-light" data-element="light" onclick="window.app?.deckBuilder?.setElementFilter('light')">
                                                    <span class="filter-icon">‚òÄÔ∏è</span><span class="filter-text">Light</span>
                                                </button>
                                                <button class="filter-btn element-dark" data-element="dark" onclick="window.app?.deckBuilder?.setElementFilter('dark')">
                                                    <span class="filter-icon">üåë</span><span class="filter-text">Dark</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Type Filter Buttons -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Type:</label>
                                            <div class="filter-buttons" id="typeButtons">
                                                <button class="filter-btn active" data-type="" onclick="window.app?.deckBuilder?.setTypeFilter('')">All</button>
                                                <button class="filter-btn" data-type="forward" onclick="window.app?.deckBuilder?.setTypeFilter('forward')">
                                                    <span class="filter-icon">‚öîÔ∏è</span><span class="filter-text">Forward</span>
                                                </button>
                                                <button class="filter-btn" data-type="backup" onclick="window.app?.deckBuilder?.setTypeFilter('backup')">
                                                    <span class="filter-icon">üõ°Ô∏è</span><span class="filter-text">Backup</span>
                                                </button>
                                                <button class="filter-btn" data-type="summon" onclick="window.app?.deckBuilder?.setTypeFilter('summon')">
                                                    <span class="filter-icon">‚ú®</span><span class="filter-text">Summon</span>
                                                </button>
                                                <button class="filter-btn" data-type="monster" onclick="window.app?.deckBuilder?.setTypeFilter('monster')">
                                                    <span class="filter-icon">üëπ</span><span class="filter-text">Monster</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Cost Filter Buttons -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Cost:</label>
                                            <div class="filter-buttons" id="costButtons">
                                                <button class="filter-btn active" data-cost="" onclick="window.app?.deckBuilder?.setCostFilter('')">All</button>
                                                <button class="filter-btn" data-cost="1" onclick="window.app?.deckBuilder?.setCostFilter('1')">1</button>
                                                <button class="filter-btn" data-cost="2" onclick="window.app?.deckBuilder?.setCostFilter('2')">2</button>
                                                <button class="filter-btn" data-cost="3" onclick="window.app?.deckBuilder?.setCostFilter('3')">3</button>
                                                <button class="filter-btn" data-cost="4" onclick="window.app?.deckBuilder?.setCostFilter('4')">4</button>
                                                <button class="filter-btn" data-cost="5" onclick="window.app?.deckBuilder?.setCostFilter('5')">5</button>
                                                <button class="filter-btn" data-cost="6" onclick="window.app?.deckBuilder?.setCostFilter('6')">6</button>
                                                <button class="filter-btn" data-cost="7+" onclick="window.app?.deckBuilder?.setCostFilter('7+')">7+</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Rarity Filter Buttons -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Rarity:</label>
                                            <div class="filter-buttons" id="rarityButtons">
                                                <button class="filter-btn active" data-rarity="" onclick="window.app?.deckBuilder?.setRarityFilter('')">All</button>
                                                <button class="filter-btn rarity-c" data-rarity="C" onclick="window.app?.deckBuilder?.setRarityFilter('C')">C</button>
                                                <button class="filter-btn rarity-r" data-rarity="R" onclick="window.app?.deckBuilder?.setRarityFilter('R')">R</button>
                                                <button class="filter-btn rarity-h" data-rarity="H" onclick="window.app?.deckBuilder?.setRarityFilter('H')">H</button>
                                                <button class="filter-btn rarity-l" data-rarity="L" onclick="window.app?.deckBuilder?.setRarityFilter('L')">L</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Opus Filter Buttons - Dynamically Generated -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Set:</label>
                                            <div class="filter-buttons" id="opusButtons">
                                                <button class="filter-btn active" data-opus="" onclick="window.app?.deckBuilder?.setOpusFilter('')">All</button>
                                                <!-- Set buttons will be dynamically generated -->
                                            </div>
                                        </div>
                                        
                                        <!-- Category Filter Buttons - Dynamically Generated -->
                                        <div class="filter-group">
                                            <label class="filter-group-label">Category:</label>
                                            <div class="filter-buttons" id="categoryButtons">
                                                <button class="filter-btn active" data-category="" onclick="window.app?.deckBuilder?.setCategoryFilter('')">All</button>
                                                <!-- Category buttons will be dynamically generated -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Content Area (Card Grid) -->
                            <div class="main-content-area">
                                <div class="card-search-panel" id="cardSearchPanel" style="display: none;">
                                    <div class="card-grid-container">
                                        <div class="card-grid" id="cardDatabase">
                                            <!-- Cards will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Deck Sidebar - Right Side -->
                            <div class="current-deck-sidebar" id="deckSidebar">
                                <div class="sidebar-toggle-bar right-toggle" onclick="toggleDeckSidebar()">
                                    <div class="toggle-handle">
                                        <span class="toggle-arrow">‚ñ∂</span>
                                        <span class="toggle-text">Deck Contents</span>
                                        <span class="toggle-icon">üìö</span>
                                    </div>
                                </div>
                                <div class="sidebar-content">
                                    <div class="current-deck-panel">
                                        <div class="sidebar-header">
                                            <h3>Deck Contents</h3>
                                            <button class="sidebar-close-btn" onclick="toggleDeckSidebar()">‚úï</button>
                                        </div>
                                        <div class="deck-list" id="currentDeck">
                                            <div class="empty-deck-message">
                                                <p>Your deck is empty. Browse cards on the left and click to add them!</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Game View -->
            <section id="gameView" class="view">
                <div class="game-container">
                    <!-- Game Controls -->
                    <div class="game-controls">
                        <div class="game-menu-btn" onclick="toggleGameMenu()">
                            <span>‚ò∞</span>
                        </div>
                        
                        <!-- Removed duplicate turn indicators and buttons - using the ones in game-controls instead -->
                    </div>

                    <!-- Compact Game Menu (hidden by default) -->
                    <div class="game-menu" id="gameMenu" style="display: none;">
                        <div class="game-menu-content">
                            <button class="game-menu-item" onclick="toggleGameMenu()">
                                <span>‚öôÔ∏è</span> Settings
                            </button>
                            <button class="game-menu-item" onclick="showGameRules()">
                                <span>üìã</span> Rules
                            </button>
                            <button class="game-menu-item" onclick="confirmLeaveGame()">
                                <span>üö™</span> Leave Game
                            </button>
                            <button class="game-menu-item" onclick="toggleGameMenu()">
                                <span>‚úï</span> Close
                            </button>
                        </div>
                    </div>

                    <!-- Right-side Event Log (Toggleable) -->
                    <div class="right-event-log" id="rightEventLog">
                        <div class="event-log-toggle" id="eventLogToggle" onclick="toggleEventLog()">
                            <span class="toggle-icon">üìã</span>
                            <span class="toggle-text">Game Log</span>
                        </div>
                        <div class="event-log-panel" id="eventLogPanel">
                            <div class="event-log-panel-header">
                                <h3>Game Event Log</h3>
                                <div class="event-log-controls">
                                    <button class="event-log-filter" id="eventLogFilter" title="Filter Events">üîç</button>
                                    <button class="event-log-clear" id="clearRightEventLog" title="Clear Log">üóëÔ∏è</button>
                                    <button class="event-log-close" id="closeEventLog" onclick="toggleEventLog()" title="Close">√ó</button>
                                </div>
                            </div>
                            <div class="event-log-panel-content" id="eventLogPanelContent">
                                <div class="event-log-empty">Game events will appear here...</div>
                            </div>
                            <div class="event-log-panel-footer">
                                <div class="event-log-stats">
                                    <span id="eventLogCount">0 events</span>
                                    <span id="eventLogPhase">Main Phase 1</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Board - Simplified Layout -->
                    <div class="game-board" id="gameBoard">
                        <!-- Left Sidebar -->
                        <div class="game-sidebar-left">
                            <!-- Damage Zone Area Buttons -->
                            <div class="life-area-container">
                                <button class="life-area-btn opponent-life" onclick="openDamageZoneModal('opponent')" id="opponentLifeBtn">
                                    <div class="life-icon">üíî</div>
                                    <div class="life-count" id="opponentLifeCount">0</div>
                                    <div class="life-label">Opp Damage</div>
                                </button>
                                <button class="life-area-btn player-life" onclick="openDamageZoneModal('player')" id="playerLifeBtn">
                                    <div class="life-icon">‚ù§Ô∏è</div>
                                    <div class="life-count" id="playerLifeCount">0</div>
                                    <div class="life-label">Your Damage</div>
                                </button>
                            </div>

                            <!-- Card Preview Area -->
                            <div class="card-preview-area" id="cardPreviewArea">
                                <div class="card-preview-header">
                                    <h3 class="card-preview-title">Card Preview</h3>
                                </div>
                                <div class="card-preview-content" id="cardPreviewContent">
                                    <div class="card-preview-placeholder">
                                        Hover or click on a card to preview it here
                                    </div>
                                </div>
                            </div>

                            <!-- Crystal Points Display Area -->
                            <div class="cp-display-area" id="cpDisplayArea">
                                <div class="cp-display-header">
                                    <h4 class="cp-display-title">Crystal Points</h4>
                                </div>
                                <div class="cp-elements-grid" id="cpElementsGrid">
                                    <div class="cp-element fire" data-element="fire">
                                        <div class="cp-element-icon">üî•</div>
                                        <div class="cp-element-value" id="cpFire">0</div>
                                    </div>
                                    <div class="cp-element ice" data-element="ice">
                                        <div class="cp-element-icon">‚ùÑÔ∏è</div>
                                        <div class="cp-element-value" id="cpIce">0</div>
                                    </div>
                                    <div class="cp-element wind" data-element="wind">
                                        <div class="cp-element-icon">üå™Ô∏è</div>
                                        <div class="cp-element-value" id="cpWind">0</div>
                                    </div>
                                    <div class="cp-element lightning" data-element="lightning">
                                        <div class="cp-element-icon">‚ö°</div>
                                        <div class="cp-element-value" id="cpLightning">0</div>
                                    </div>
                                    <div class="cp-element water" data-element="water">
                                        <div class="cp-element-icon">üíß</div>
                                        <div class="cp-element-value" id="cpWater">0</div>
                                    </div>
                                    <div class="cp-element earth" data-element="earth">
                                        <div class="cp-element-icon">üåç</div>
                                        <div class="cp-element-value" id="cpEarth">0</div>
                                    </div>
                                    <div class="cp-element light" data-element="light">
                                        <div class="cp-element-icon">‚òÄÔ∏è</div>
                                        <div class="cp-element-value" id="cpLight">0</div>
                                    </div>
                                    <div class="cp-element dark" data-element="dark">
                                        <div class="cp-element-icon">üåë</div>
                                        <div class="cp-element-value" id="cpDark">0</div>
                                    </div>
                                </div>
                                <div class="cp-total">
                                    Total: <span id="cpTotalValue">0</span> CP
                                </div>
                            </div>

                            <!-- Event Log Area -->
                            <div class="event-log-area" id="eventLogArea">
                                <div class="event-log-header">
                                    <h4 class="event-log-title">Game Log</h4>
                                    <div class="event-log-controls">
                                        <button class="event-log-expand" id="expandEventLog" title="Open Event Log Viewer">üìã</button>
                                        <button class="event-log-minimize" id="minimizeEventLog" title="Minimize/Expand Log">‚ûñ</button>
                                        <button class="event-log-clear" id="clearEventLog" title="Clear Log">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="event-log-content" id="eventLogContent">
                                    <div class="event-log-inner-wrapper">
                                        <div class="event-log-empty">Game events will appear here...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Game Area -->
                        <div class="game-main-area">
                            <!-- Opponent Hand and CP Area -->
                            <div class="opponent-hand-cp-area">
                                <div class="hand-area opponent-hand-area">
                                    <div class="hand-header">Opponent Hand</div>
                                    <div class="hand-count" id="opponentHandCount">7 cards</div>
                                </div>
                                <div class="cp-display opponent-cp" id="opponentCP">
                                    <!-- CP icons will be dynamically generated based on deck elements -->
                                </div>
                                <!-- Opponent Damage Zone Display -->
                                <div class="damage-zone-display opponent-damage-zone">
                                    <div class="damage-zone-header">Opponent Damage Zone</div>
                                    <div class="damage-zone-grid" id="opponentDamageZone">
                                        <!-- Damage cards will appear here -->
                                    </div>
                                </div>
                                <div class="zone-buttons opponent-zone-buttons">
                                    <button class="zone-btn break-zone-btn" onclick="openZoneModal('opponent-break')" id="opponentBreakBtn" title="View Opponent Break Zone">
                                        <div class="zone-icon">üìö</div>
                                        <div class="zone-count" id="opponentBreakCount">0</div>
                                        <div class="zone-label">Break</div>
                                    </button>
                                    <button class="zone-btn removed-zone-btn" onclick="openZoneModal('opponent-removed')" id="opponentRemovedBtn" title="View Opponent Removed">
                                        <div class="zone-icon">üö´</div>
                                        <div class="zone-count" id="opponentRemovedCount">0</div>
                                        <div class="zone-label">Removed</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Opponent Backups -->
                            <div class="game-zone opponent-backups" id="opponentBackups">
                                <div class="zone-content" id="opponentBackupsContent">
                                    <div class="zone-empty">Backup Area</div>
                                </div>
                                <span class="zone-count hidden" id="opponentBackupsCount">0</span>
                            </div>

                            <!-- Opponent Forwards -->
                            <div class="game-zone opponent-forwards" id="opponentBattlefield">
                                <div class="zone-content" id="opponentBattlefieldContent">
                                    <div class="zone-empty">Forward Area</div>
                                </div>
                                <span class="zone-count hidden" id="opponentBattlefieldCount">0</span>
                            </div>

                            <!-- Dynamic Switch Phase/End Turn Button -->
                            <div class="dynamic-action-area">
                                <div class="turn-info">
                                    <span class="current-player" id="currentPlayer">Your Turn</span>
                                    <span class="turn-phase" id="turnPhase">Main Phase</span>
                                </div>
                                <button class="dynamic-action-btn" id="dynamicActionBtn" onclick="handleDynamicAction()">Switch Phase</button>
                            </div>

                            <!-- Player Forwards -->
                            <div class="game-zone player-forwards" id="playerBattlefield">
                                <div class="zone-content" id="playerBattlefieldContent">
                                    <div class="zone-empty">Forward Area</div>
                                </div>
                                <span class="zone-count hidden" id="playerBattlefieldCount">0</span>
                            </div>

                            <!-- Player Backups -->
                            <div class="game-zone player-backups" id="playerBackups">
                                <div class="zone-content" id="playerBackupsContent">
                                    <div class="zone-empty">Backup Area</div>
                                </div>
                                <span class="zone-count hidden" id="playerBackupsCount">0</span>
                            </div>

                            <!-- Player Hand and CP Area -->
                            <div class="player-hand-cp-area">
                                <div class="hand-area player-hand-area" id="playerHand">
                                    <div class="hand-header">Your Hand</div>
                                    <div class="hand-content" id="playerHandContent">
                                        <!-- Player hand cards will appear here -->
                                    </div>
                                </div>
                                <div class="cp-display player-cp" id="playerCP">
                                    <!-- CP icons will be dynamically generated based on deck elements -->
                                </div>
                                <!-- Player Damage Zone Display -->
                                <div class="damage-zone-display player-damage-zone">
                                    <div class="damage-zone-header">Your Damage Zone</div>
                                    <div class="damage-zone-grid" id="playerDamageZone">
                                        <!-- Damage cards will appear here -->
                                    </div>
                                </div>
                                <div class="zone-buttons player-zone-buttons">
                                    <button class="zone-btn break-zone-btn" onclick="openZoneModal('player-break')" id="playerBreakBtn" title="View Break Zone (Graveyard)">
                                        <div class="zone-icon">üìö</div>
                                        <div class="zone-count" id="playerBreakCount">0</div>
                                        <div class="zone-label">Break</div>
                                    </button>
                                    <button class="zone-btn removed-zone-btn" onclick="openZoneModal('player-removed')" id="playerRemovedBtn" title="View Removed from Game">
                                        <div class="zone-icon">üö´</div>
                                        <div class="zone-count" id="playerRemovedCount">0</div>
                                        <div class="zone-label">Removed</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- NOTE: Floating Hand Cards removed - now integrated into game board layout -->

                        <!-- Hidden Zone Content for Unified Modal -->
                        <div style="display: none;">
                            <div id="playerDamageContent"></div>
                            <div id="playerBreakContent"></div>
                            <div id="playerRemovedContent"></div>
                            <div id="opponentDamageContent"></div>
                            <div id="opponentBreakContent"></div>
                            <div id="opponentRemovedContent"></div>
                        </div>

                        <!-- Card Context Menu -->
                        <div class="card-context-menu" id="cardContextMenu" style="display: none;">
                            <button class="context-menu-item" id="playCardOption">
                                <span class="context-icon">‚ö°</span>
                                <span class="context-text">Play Card</span>
                            </button>
                            <button class="context-menu-item" id="discardForCPOption">
                                <span class="context-icon">üî•</span>
                                <span class="context-text">Discard for 2 CP</span>
                            </button>
                            <button class="context-menu-item" id="tapBackupOption" style="display: none;">
                                <span class="context-icon">üíé</span>
                                <span class="context-text">Tap for 1 CP</span>
                            </button>
                            <button class="context-menu-item" id="viewCardOption">
                                <span class="context-icon">üëÅÔ∏è</span>
                                <span class="context-text">View Details</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile View -->
            <section id="profileView" class="view">
                <div class="profile-container">
                    <h2>Player Profile</h2>
                    <!-- Profile management interface -->
                </div>
            </section>

            <!-- Practice Lobby View -->
            <section id="practice-lobbyView" class="view">
                <div class="lobby-container">
                    <!-- Lobby Header -->
                    <div class="lobby-header">
                        <button class="btn btn-secondary" onclick="window.app.switchView('home')">
                            ‚Üê Back to Home
                        </button>
                        <h2 class="lobby-title">Practice Game Lobby</h2>
                        <div class="lobby-status">
                            <span class="status-indicator ready">Ready</span>
                        </div>
                    </div>

                    <!-- Main Lobby Content -->
                    <div class="lobby-content">
                        <!-- Player Section -->
                        <div class="lobby-section player-section">
                            <h3 class="section-title">You</h3>
                            <div class="player-card player-card-you">
                                <div class="player-avatar" id="lobbyPlayerAvatar">‚ö°</div>
                                <div class="player-info">
                                    <h4 class="player-name" id="lobbyPlayerName">Your Name</h4>
                                    <p class="player-stats" id="lobbyPlayerStats">Games: 0 | Wins: 0</p>
                                </div>
                                <div class="player-deck-info">
                                    <div class="deck-selector">
                                        <label for="playerDeckSelect">Select Deck:</label>
                                        <select id="playerDeckSelect" class="deck-select">
                                            <option value="">Choose a deck...</option>
                                        </select>
                                        <button class="btn btn-secondary btn-small" onclick="window.app.switchView('deck-builder')">
                                            Create Deck
                                        </button>
                                    </div>
                                    <div class="selected-deck-preview" id="playerDeckPreview" style="display: none;">
                                        <div class="deck-preview-header">
                                            <h5 class="deck-name"></h5>
                                            <span class="deck-card-count"></span>
                                        </div>
                                        <div class="deck-elements"></div>
                                        <div class="deck-categories"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VS Indicator -->
                        <div class="lobby-vs">
                            <div class="vs-circle">VS</div>
                        </div>

                        <!-- AI Opponent Section -->
                        <div class="lobby-section opponent-section">
                            <h3 class="section-title">AI Opponent</h3>
                            <div class="player-card player-card-ai">
                                <div class="player-avatar ai-avatar" id="aiAvatar">ü§ñ</div>
                                <div class="player-info">
                                    <h4 class="player-name" id="aiName">AI Opponent</h4>
                                    <p class="player-stats ai-difficulty" id="aiDifficulty">Select Difficulty</p>
                                </div>
                                <div class="ai-settings">
                                    <div class="difficulty-selector">
                                        <label for="aiDifficultySelect">Difficulty:</label>
                                        <select id="aiDifficultySelect" class="difficulty-select">
                                            <option value="">Choose difficulty...</option>
                                            <option value="easy">Easy - Learning AI</option>
                                            <option value="medium">Medium - Balanced AI</option>
                                            <option value="hard">Hard - Competitive AI</option>
                                        </select>
                                    </div>
                                    <div class="ai-deck-info" id="aiDeckInfo" style="display: none;">
                                        <div class="ai-deck-preview">
                                            <h5 class="ai-deck-name"></h5>
                                            <p class="ai-deck-description"></p>
                                            <div class="ai-deck-stats">
                                                <span class="ai-deck-element"></span>
                                                <span class="ai-deck-strategy"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lobby Actions -->
                    <div class="lobby-actions">
                        <div class="lobby-settings">
                            <label>
                                <input type="checkbox" id="enableTutorial" checked>
                                Show tutorial hints
                            </label>
                            <label>
                                <input type="checkbox" id="allowUndo">
                                Allow undo moves
                            </label>
                        </div>
                        <div class="lobby-buttons">
                            <button class="btn btn-secondary" onclick="window.app.switchView('home')">
                                Cancel
                            </button>
                            <button class="btn btn-primary" id="startPracticeBtn" disabled onclick="startPracticeFromLobby()">
                                Start Practice Game
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Card Detail Modal -->
    <div id="cardDetailModal" class="card-detail-modal" style="display: none;">
        <div class="card-detail-overlay"></div>
        <div class="card-detail-content">
            <div class="card-detail-image">
                <img id="cardDetailImg" src="" alt="Card Image" class="card-detail-img">
            </div>
            <div class="card-detail-info">
                <h2 id="cardDetailName" class="card-detail-name"></h2>
                <div class="card-detail-stats">
                    <div class="card-detail-stat">
                        <span class="stat-label">Cost:</span>
                        <span id="cardDetailCost" class="stat-value"></span>
                    </div>
                    <div class="card-detail-stat">
                        <span class="stat-label">Element:</span>
                        <span id="cardDetailElement" class="stat-value"></span>
                    </div>
                    <div class="card-detail-stat">
                        <span class="stat-label">Category:</span>
                        <span id="cardDetailCategory" class="stat-value"></span>
                    </div>
                    <div class="card-detail-stat">
                        <span class="stat-label">Type:</span>
                        <span id="cardDetailType" class="stat-value"></span>
                    </div>
                    <div id="cardDetailPowerBlock" class="card-detail-stat" style="display: none;">
                        <span class="stat-label">Power:</span>
                        <span id="cardDetailPower" class="stat-value"></span>
                    </div>
                </div>
                <div class="card-detail-text-section">
                    <h3>Card Text</h3>
                    <div id="cardDetailText" class="card-detail-text"></div>
                </div>
                <div class="card-detail-dismiss-hint">
                    Right-click any card to view details ‚Ä¢ Press any key or click to close
                </div>
            </div>
        </div>
    </div>

    <!-- Zone Overview Modal -->
    <div id="zoneOverviewModal" class="zone-overview-modal" style="display: none;">
        <div class="zone-overview-overlay"></div>
        <div class="zone-overview-content">
            <div class="zone-overview-header">
                <h2 id="zoneOverviewTitle" class="zone-overview-title"></h2>
                <div class="zone-overview-stats">
                    <span id="zoneOverviewCount" class="zone-card-count">0 cards</span>
                    <span id="zoneOverviewCP" class="zone-cp-display" style="display: none;">CP: 0</span>
                </div>
                <button class="zone-overview-close" onclick="hideZoneOverviewModal()">‚úï</button>
            </div>
            <div class="zone-overview-body">
                <div id="zoneOverviewCards" class="zone-overview-cards">
                    <!-- Cards will be populated here -->
                </div>
                <div id="zoneOverviewEmpty" class="zone-overview-empty" style="display: none;">
                    <div class="empty-zone-icon">üì≠</div>
                    <p>This zone is empty</p>
                </div>
            </div>
            <div class="zone-overview-footer">
                <span class="zone-overview-hint">Click on any card for details ‚Ä¢ Press any key or click outside to close</span>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Event Log Viewer Modal -->
    <div class="event-log-viewer-modal" id="eventLogViewerModal">
        <div class="event-log-viewer-overlay"></div>
        <div class="event-log-viewer-content">
            <div class="event-log-viewer-header">
                <h2 class="event-log-viewer-title">üìã Game Event Log Viewer</h2>
                <div class="event-log-viewer-controls">
                    <button class="event-log-filter-btn" id="eventLogFilterBtn" title="Filter Events">üîç</button>
                    <button class="event-log-export-btn" id="eventLogExportBtn" title="Export Log">üì§</button>
                    <button class="event-log-viewer-close" id="closeEventLogViewer" title="Close (Esc)">√ó</button>
                </div>
            </div>
            <div class="event-log-viewer-body">
                <div class="event-log-viewer-stats">
                    <span id="eventLogViewerCount">0 events</span>
                    <span>‚Ä¢</span>
                    <span id="eventLogViewerPhase">Loading...</span>
                </div>
                <div class="event-log-viewer-content-area" id="eventLogViewerContent">
                    <!-- Event entries will be populated here -->
                </div>
            </div>
            <div class="event-log-viewer-footer">
                <div class="event-log-viewer-tip">üí° Use filters to narrow down events, or export the full log</div>
            </div>
        </div>
    </div>

    <!-- Mulligan Modal -->
    <div class="mulligan-modal" id="mulliganModal">
        <div class="mulligan-overlay"></div>
        <div class="mulligan-content">
            <div class="mulligan-header">
                <h2 class="mulligan-title">üîÑ Opening Hand - Mulligan Decision</h2>
                <div class="mulligan-subtitle">Review your starting hand and decide if you want to mulligan (shuffle and draw 5 new cards)</div>
            </div>
            <div class="mulligan-body">
                <div class="mulligan-hand-preview" id="mulliganHandPreview">
                    <div class="mulligan-hand-label">Your Opening Hand (5 cards):</div>
                    <div class="mulligan-hand-cards" id="mulliganHandCards">
                        <!-- Current hand cards will be displayed here -->
                    </div>
                </div>
                <div class="mulligan-decision">
                    <div class="mulligan-explanation">
                        <p><strong>Keep this hand?</strong></p>
                        <ul>
                            <li>‚úÖ <strong>Keep:</strong> Start the game with this hand</li>
                            <li>üîÑ <strong>Mulligan:</strong> Shuffle this hand back into your deck and draw 5 new cards</li>
                        </ul>
                        <p class="mulligan-note">üí° <em>You can only mulligan once per game</em></p>
                    </div>
                </div>
            </div>
            <div class="mulligan-footer">
                <button class="btn btn-primary mulligan-keep-btn" id="mulliganKeepBtn" onclick="keepOpeningHand()">
                    ‚úÖ Keep This Hand
                </button>
                <button class="btn btn-secondary mulligan-redraw-btn" id="mulliganRedrawBtn" onclick="mulliganOpeningHand()">
                    üîÑ Mulligan (Redraw)
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="src/main.js"></script>
    
    <!-- Sidebar Toggle Functions -->
    <script>
        // Update main content margins based on sidebar states
        function updateMainContentMargins() {
            const mainContent = document.querySelector('.main-content-area');
            const searchSidebar = document.getElementById('searchFilterSidebar');
            const deckSidebar = document.getElementById('deckSidebar');
            
            if (!mainContent) return;
            
            const searchCollapsed = searchSidebar.classList.contains('collapsed');
            const deckCollapsed = deckSidebar.classList.contains('collapsed');
            
            // Reset classes
            mainContent.classList.remove('search-collapsed', 'deck-collapsed');
            
            // Add classes based on current state
            if (searchCollapsed) mainContent.classList.add('search-collapsed');
            if (deckCollapsed) mainContent.classList.add('deck-collapsed');
        }
        
        // Update edge bar visibility
        function updateEdgeBars() {
            const leftEdgeBar = document.getElementById('leftEdgeBar');
            const rightEdgeBar = document.getElementById('rightEdgeBar');
            const searchSidebar = document.getElementById('searchFilterSidebar');
            const deckSidebar = document.getElementById('deckSidebar');
            
            // Show left edge bar only when search sidebar is collapsed
            if (leftEdgeBar) {
                leftEdgeBar.style.display = searchSidebar.classList.contains('collapsed') ? 'flex' : 'none';
            }
            
            // Show right edge bar only when deck sidebar is collapsed
            if (rightEdgeBar) {
                rightEdgeBar.style.display = deckSidebar.classList.contains('collapsed') ? 'flex' : 'none';
            }
        }
        
        // Toggle search/filter sidebar
        function toggleSearchSidebar() {
            const sidebar = document.getElementById('searchFilterSidebar');
            sidebar.classList.toggle('collapsed');
            
            // Update UI
            updateMainContentMargins();
            updateEdgeBars();
            
            // Save state to localStorage
            localStorage.setItem('searchSidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Toggle deck contents sidebar
        function toggleDeckSidebar() {
            const sidebar = document.getElementById('deckSidebar');
            sidebar.classList.toggle('collapsed');
            
            // Update UI
            updateMainContentMargins();
            updateEdgeBars();
            
            // Save state to localStorage
            localStorage.setItem('deckSidebarCollapsed', sidebar.classList.contains('collapsed'));
        }
        
        // Restore sidebar states on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Restore search sidebar state
            const searchCollapsed = localStorage.getItem('searchSidebarCollapsed') === 'true';
            if (searchCollapsed) {
                document.getElementById('searchFilterSidebar').classList.add('collapsed');
            }
            
            // Restore deck sidebar state
            const deckCollapsed = localStorage.getItem('deckSidebarCollapsed') === 'true';
            if (deckCollapsed) {
                document.getElementById('deckSidebar').classList.add('collapsed');
            }
            
            // Update UI after restoring states
            setTimeout(() => {
                updateMainContentMargins();
                updateEdgeBars();
            }, 100);
        });
        
        // Keyboard shortcuts for sidebar toggling
        document.addEventListener('keydown', function(e) {
            // Only activate when in deck builder view and not typing in inputs
            if (!document.getElementById('deck-builderView').classList.contains('active') || 
                e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // Ctrl/Cmd + [ to toggle search sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === '[') {
                e.preventDefault();
                toggleSearchSidebar();
            }
            
            // Ctrl/Cmd + ] to toggle deck sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === ']') {
                e.preventDefault();
                toggleDeckSidebar();
            }
        });
        
        // NOTE: toggleFloatingHand() and toggleHand() functions removed - 
        // Hand display is now integrated directly into the game board layout

        // Card hover integration with preview
        function handleCardHover(cardElement, isHovering) {
            const previewArea = document.querySelector('.card-preview-content');
            const previewImage = document.querySelector('.card-preview-image');
            
            if (isHovering) {
                // Add hover effect to preview area
                if (previewArea) previewArea.classList.add('card-hovered');
                if (previewImage) previewImage.classList.add('card-hovered');
                
                // Update preview with card data (if GameBoard component has showCardPreview method)
                if (window.app?.gameBoard?.showCardPreview) {
                    const cardData = cardElement.cardData || {
                        name: cardElement.querySelector('.card-name')?.textContent || 'Unknown Card',
                        cost: cardElement.querySelector('.card-cost')?.textContent || '?',
                        element: 'Unknown'
                    };
                    window.app.gameBoard.showCardPreview(cardData);
                }
            } else {
                // Remove hover effects
                if (previewArea) previewArea.classList.remove('card-hovered');
                if (previewImage) previewImage.classList.remove('card-hovered');
            }
        }

        // NOTE: setupFloatingHandHovers() removed - card hover is now handled by GameBoard.js

        // Call this when hand cards are added to the DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Set up mutation observer to detect when hand cards are added
            const handContent = document.getElementById('playerHandContent');
            if (handContent) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // Cards were added, set up hover listeners
                            // NOTE: Card hover setup now handled by GameBoard.js
                        }
                    });
                });
                
                observer.observe(handContent, {
                    childList: true,
                    subtree: true
                });
            }
        });

        // Game menu functions
        function toggleGameMenu() {
            const menu = document.getElementById('gameMenu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                setTimeout(() => menu.classList.add('show'), 10);
            } else {
                menu.classList.remove('show');
                setTimeout(() => menu.style.display = 'none', 200);
            }
        }

        function confirmLeaveGame() {
            if (confirm('Are you sure you want to leave the current game?')) {
                toggleGameMenu();
                window.app?.switchView('home');
            }
        }

        function showGameRules() {
            toggleGameMenu();
            if (window.app && window.app.modal) {
                window.app.modal.open('gameRules');
            }
        }

        // Close game menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('gameMenu');
            const menuBtn = document.querySelector('.game-menu-btn');
            
            if (menu && menu.classList.contains('show') && 
                !menu.contains(e.target) && !menuBtn.contains(e.target)) {
                toggleGameMenu();
            }
        });

        // Simplified Practice Lobby Functions - Main logic now in PracticeLobby.js component
        function startPracticeFromLobby() {
            if (window.app?.practiceLobby) {
                window.app.practiceLobby.startPracticeGame().catch(error => {
                    console.error('Failed to start practice game:', error);
                    alert('Failed to start practice game: ' + error.message);
                });
            } else {
                alert('Practice lobby not ready. Please wait and try again.');
            }
        }

        // Card Detail Modal System
        let currentHoveredCard = null;
        let cardDetailModalOpen = false;

        // Track currently hovered card
        function setCurrentHoveredCard(cardElement) {
            currentHoveredCard = cardElement;
        }

        function clearCurrentHoveredCard() {
            currentHoveredCard = null;
        }

        // Show detailed card modal
        function showCardDetailModal(cardData) {
            const modal = document.getElementById('cardDetailModal');
            const img = document.getElementById('cardDetailImg');
            const name = document.getElementById('cardDetailName');
            const cost = document.getElementById('cardDetailCost');
            const element = document.getElementById('cardDetailElement');
            const category = document.getElementById('cardDetailCategory');
            const type = document.getElementById('cardDetailType');
            const power = document.getElementById('cardDetailPower');
            const powerBlock = document.getElementById('cardDetailPowerBlock');
            const text = document.getElementById('cardDetailText');

            if (!modal || !cardData) return;

            // Populate modal with card data
            if (img && cardData.imageUrl) {
                img.src = cardData.imageUrl;
                img.alt = cardData.name || 'Card Image';
            }
            
            if (name) name.textContent = cardData.name || 'Unknown Card';
            if (cost) cost.textContent = cardData.cost || '?';
            if (element) element.textContent = cardData.element || 'None';
            if (category) category.textContent = cardData.category || 'Unknown';
            if (type) type.textContent = cardData.type || 'Unknown';
            
            // Show/hide power for forwards and monsters
            if (powerBlock && power) {
                if (cardData.power && (cardData.type === 'forward' || cardData.type === 'monster')) {
                    power.textContent = cardData.power;
                    powerBlock.style.display = 'flex';
                } else {
                    powerBlock.style.display = 'none';
                }
            }

            // Populate and highlight card text
            if (text && cardData.text) {
                text.innerHTML = highlightCardText(cardData.text);
            } else if (text) {
                text.textContent = 'No card text available.';
            }

            // Show modal
            modal.style.display = 'flex';
            cardDetailModalOpen = true;

            // Prevent scroll
            document.body.style.overflow = 'hidden';
        }

        // Hide card detail modal
        function hideCardDetailModal() {
            const modal = document.getElementById('cardDetailModal');
            if (modal) {
                modal.style.display = 'none';
                cardDetailModalOpen = false;
                document.body.style.overflow = '';
            }
        }

        // Highlight keywords and abilities in card text
        function highlightCardText(text) {
            if (!text) return '';
            
            // Common FFTCG keywords to highlight
            const keywords = [
                'Haste', 'First Strike', 'Brave', 'Vigilance', 'Multicast', 'Ex Burst',
                'Dull', 'Break', 'Search', 'Draw', 'Discard', 'Activate', 'Auto',
                'Field', 'Hand', 'Damage Zone', 'Break Zone', 'EX Burst', 'S Ability',
                'Special Ability', 'Action Ability', 'Backup', 'Forward', 'Summon',
                'Monster', 'Choose', 'Pay', 'Cast', 'Play', 'Remove', 'Return',
                'Crystal Points', 'CP', 'Power', 'Job', 'Category'
            ];

            let highlightedText = text;

            // Highlight keywords
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="keyword">$1</span>');
            });

            // Highlight ability names (text in brackets)
            highlightedText = highlightedText.replace(/\[([^\]]+)\]/g, '<span class="ability-name">[$1]</span>');

            // Highlight cost references (numbers in parentheses for costs)
            highlightedText = highlightedText.replace(/\((\d+)\)/g, '<span class="cost-reference">($1)</span>');

            return highlightedText;
        }

        // Keyboard event handler for closing modal
        document.addEventListener('keydown', function(e) {
            // Only work in game view
            if (!document.getElementById('gameView').classList.contains('active')) {
                return;
            }

            // Hide modal on any key press when modal is open
            if (cardDetailModalOpen) {
                e.preventDefault();
                hideCardDetailModal();
            }
        });

        // Right-click handler for showing card detail modal
        document.addEventListener('contextmenu', function(e) {
            // Only work in game view
            if (!document.getElementById('gameView').classList.contains('active')) {
                return;
            }

            const cardElement = e.target.closest('.game-card');
            if (cardElement && !cardDetailModalOpen) {
                e.preventDefault(); // Prevent default context menu
                
                // Get card data from the clicked card element
                const cardData = extractCardDataFromElement(cardElement);
                if (cardData) {
                    showCardDetailModal(cardData);
                }
            }
        });

        // Hide modal on left click when open
        document.addEventListener('click', function(e) {
            if (cardDetailModalOpen) {
                hideCardDetailModal();
            }
        });

        // Extract card data from a card element
        function extractCardDataFromElement(cardElement) {
            if (!cardElement) return null;

            // Get card ID from dataset
            const cardId = cardElement.dataset.cardId;
            
            // Try to get card data from the game board's card database
            let card = null;
            if (cardId && window.app?.gameBoard?.cardDatabase) {
                card = window.app.gameBoard.cardDatabase.getCard(cardId);
            }
            
            // If we have card data from database, use it; otherwise fall back to DOM parsing
            if (card) {
                return {
                    name: card.name || 'Unknown Card',
                    cost: card.cost || '?',
                    element: card.element || 'None',
                    category: card.category || card.categories?.[0] || 'Unknown',
                    type: card.type || 'Unknown',
                    power: card.power || '',
                    text: card.text || card.abilities?.join('\n') || 'No card text available.',
                    imageUrl: cardElement.querySelector('.card-real-image')?.src || card.image || ''
                };
            } else {
                // Fallback to DOM parsing if database lookup fails
                return {
                    name: cardElement.querySelector('.card-name')?.textContent || 'Unknown Card',
                    cost: cardElement.querySelector('.card-cost')?.textContent || '?',
                    element: cardElement.className.match(/element-(\w+)/)?.[1] || 'None',
                    category: 'Unknown',
                    type: 'Unknown',
                    power: '',
                    text: 'No card text available.',
                    imageUrl: cardElement.querySelector('.card-real-image')?.src || ''
                };
            }
        }

        // Set up card hover tracking for the modal system
        function setupCardHoverTracking() {
            // Set up hover tracking for all game cards
            document.addEventListener('mouseover', function(e) {
                const cardElement = e.target.closest('.game-card');
                if (cardElement && document.getElementById('gameView').classList.contains('active')) {
                    setCurrentHoveredCard(cardElement);
                }
            });

            document.addEventListener('mouseout', function(e) {
                const cardElement = e.target.closest('.game-card');
                if (cardElement && document.getElementById('gameView').classList.contains('active')) {
                    // Only clear if we're leaving the specific card
                    if (!cardElement.contains(e.relatedTarget)) {
                        clearCurrentHoveredCard();
                    }
                }
            });
        }

        // Zone Overview Modal System
        let zoneOverviewModalOpen = false;

        // Open unified zone modal for graveyard and removed cards
        function openUnifiedZoneModal(player) {
            const modal = document.getElementById('zoneOverviewModal');
            const title = document.getElementById('zoneOverviewTitle');
            const content = document.getElementById('zoneOverviewContent');
            
            if (!modal || !title || !content) {
                console.error('Zone modal elements not found');
                return;
            }
            
            // Set title
            title.textContent = `${player === 'player' ? 'Your' : 'Opponent'} Graveyard & Removed Cards`;
            
            // Create tabbed interface
            content.innerHTML = `
                <div class="zone-tabs">
                    <button class="zone-tab active" onclick="showZoneTab('graveyard', '${player}')">
                        <span class="tab-icon">ü™¶</span>
                        <span class="tab-text">Graveyard</span>
                        <span class="tab-count" id="${player}GraveyardTabCount">0</span>
                    </button>
                    <button class="zone-tab" onclick="showZoneTab('removed', '${player}')">
                        <span class="tab-icon">üö´</span>
                        <span class="tab-text">Removed</span>
                        <span class="tab-count" id="${player}RemovedTabCount">0</span>
                    </button>
                </div>
                <div class="zone-tab-content">
                    <div id="graveyardContent" class="tab-panel active">
                        <div class="zone-empty">No cards in graveyard</div>
                    </div>
                    <div id="removedContent" class="tab-panel">
                        <div class="zone-empty">No cards removed from game</div>
                    </div>
                </div>
            `;
            
            // Load initial content
            showZoneTab('graveyard', player);
            
            // Show modal
            modal.style.display = 'flex';
            zoneOverviewModalOpen = true;
        }
        
        // Show specific tab in unified zone modal
        function showZoneTab(tabType, player) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.zone-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event?.target.closest('.zone-tab')?.classList.add('active');
            
            // Update tab panels
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabType}Content`).classList.add('active');
            
            // Load content based on tab type
            const content = document.getElementById(`${tabType}Content`);
            if (tabType === 'graveyard') {
                loadGraveyardContent(content, player);
            } else if (tabType === 'removed') {
                loadRemovedContent(content, player);
            }
        }
        
        // Load graveyard content
        function loadGraveyardContent(container, player) {
            // This would load from the game board's break zone
            if (window.app?.gameBoard?.breakZones) {
                const cards = window.app.gameBoard.breakZones[player] || [];
                if (cards.length === 0) {
                    container.innerHTML = '<div class="zone-empty">No cards in graveyard</div>';
                } else {
                    container.innerHTML = cards.map(card => 
                        `<div class="zone-card" onclick="viewCard('${card.id}')">
                            <div class="card-mini">${card.name || 'Unknown Card'}</div>
                        </div>`
                    ).join('');
                }
                
                // Update tab count
                const tabCount = document.getElementById(`${player}GraveyardTabCount`);
                if (tabCount) tabCount.textContent = cards.length;
            } else {
                container.innerHTML = '<div class="zone-empty">No cards in graveyard</div>';
            }
        }
        
        // Load removed content
        function loadRemovedContent(container, player) {
            // This would load from the game board's removed zone
            if (window.app?.gameBoard?.removedZones) {
                const cards = window.app.gameBoard.removedZones[player] || [];
                if (cards.length === 0) {
                    container.innerHTML = '<div class="zone-empty">No cards removed from game</div>';
                } else {
                    container.innerHTML = cards.map(card => 
                        `<div class="zone-card" onclick="viewCard('${card.id}')">
                            <div class="card-mini">${card.name || 'Unknown Card'}</div>
                        </div>`
                    ).join('');
                }
                
                // Update tab count
                const tabCount = document.getElementById(`${player}RemovedTabCount`);
                if (tabCount) tabCount.textContent = cards.length;
            } else {
                container.innerHTML = '<div class="zone-empty">No cards removed from game</div>';
            }
        }

        // Legacy function for backward compatibility
        function openZoneModal(zoneType) {
            const zoneNames = {
                'player-damage': { 
                    name: 'playerDamageContent', 
                    title: 'Your Damage Zone',
                    type: 'player-damage'
                },
                'player-break': { 
                    name: 'playerBreakContent', 
                    title: 'Your Break Zone',
                    type: 'player-break'
                },
                'opponent-damage': { 
                    name: 'opponentDamageContent', 
                    title: 'Opponent Damage Zone',
                    type: 'opponent-damage'
                },
                'opponent-break': { 
                    name: 'opponentBreakContent', 
                    title: 'Opponent Break Zone',
                    type: 'opponent-break'
                },
                'player-removed': { 
                    name: 'playerRemovedContent', 
                    title: 'Your Removed Cards',
                    type: 'player-removed'
                },
                'opponent-removed': { 
                    name: 'opponentRemovedContent', 
                    title: 'Opponent Removed Cards',
                    type: 'opponent-removed'
                }
            };
            
            const zoneInfo = zoneNames[zoneType];
            if (zoneInfo) {
                showZoneOverviewModal(zoneInfo.name, zoneInfo.type);
            }
        }

        // Show zone overview modal
        function showZoneOverviewModal(zoneName, zoneType) {
            const modal = document.getElementById('zoneOverviewModal');
            const title = document.getElementById('zoneOverviewTitle');
            const count = document.getElementById('zoneOverviewCount');
            const cpDisplay = document.getElementById('zoneOverviewCP');
            const cardsContainer = document.getElementById('zoneOverviewCards');
            const emptyMessage = document.getElementById('zoneOverviewEmpty');

            if (!modal) return;

            // Get zone element and cards
            const zoneElement = getZoneElement(zoneName);
            if (!zoneElement) return;

            const cards = Array.from(zoneElement.querySelectorAll('.game-card'));
            
            // Set title
            const formattedZoneName = formatZoneName(zoneName);
            if (title) title.textContent = formattedZoneName;

            // Set card count
            if (count) {
                const cardCount = cards.length;
                count.textContent = `${cardCount} card${cardCount !== 1 ? 's' : ''}`;
            }

            // Show/hide CP display for backup zones
            if (cpDisplay) {
                // CP display is handled by the modular CP system
                cpDisplay.style.display = 'none';
            }

            // Populate cards
            if (cardsContainer && emptyMessage) {
                if (cards.length === 0) {
                    cardsContainer.style.display = 'none';
                    emptyMessage.style.display = 'flex';
                } else {
                    cardsContainer.style.display = 'grid';
                    emptyMessage.style.display = 'none';
                    cardsContainer.innerHTML = '';

                    cards.forEach((cardElement, index) => {
                        const cardData = extractCardDataFromElement(cardElement);
                        if (cardData) {
                            const zoneCard = createZoneOverviewCard(cardData, cardElement);
                            cardsContainer.appendChild(zoneCard);
                        }
                    });
                }
            }

            // Show modal
            modal.style.display = 'flex';
            zoneOverviewModalOpen = true;
            document.body.style.overflow = 'hidden';
        }

        // Hide zone overview modal
        function hideZoneOverviewModal() {
            const modal = document.getElementById('zoneOverviewModal');
            if (modal) {
                modal.style.display = 'none';
                zoneOverviewModalOpen = false;
                document.body.style.overflow = '';
            }
        }

        // Create a card element for the zone overview
        function createZoneOverviewCard(cardData, originalElement) {
            const card = document.createElement('div');
            card.className = 'zone-overview-card';
            
            // Check if card is tapped
            if (originalElement && originalElement.classList.contains('tapped')) {
                card.classList.add('tapped');
            }

            const powerDisplay = (cardData.power && (cardData.type === 'forward' || cardData.type === 'monster')) 
                ? `<span class="zone-card-power">${cardData.power}</span>` 
                : '';

            card.innerHTML = `
                <div class="zone-card-name">${cardData.name}</div>
                <div class="zone-card-details">
                    <span class="zone-card-cost">${cardData.cost}</span>
                    <span class="zone-card-element element-${cardData.element}">${cardData.element}</span>
                </div>
                <div class="zone-card-details">
                    <span class="zone-card-type">${cardData.type}</span>
                    ${powerDisplay}
                </div>
            `;

            // Add click handler to show card detail modal
            card.addEventListener('click', (e) => {
                e.stopPropagation();
                hideZoneOverviewModal();
                setTimeout(() => showCardDetailModal(cardData), 100);
            });

            // Store card data on element for potential future use
            card.cardData = cardData;

            return card;
        }

        // Get zone element by zone name
        function getZoneElement(zoneName) {
            const zoneMap = {
                'playerBackups': 'playerBackupsContent',
                'playerSummons': 'playerSummonsContent', 
                'playerDamage': 'playerDamageContent',
                'playerBreakContent': 'playerBreakContent',
                'opponentBackups': 'opponentBackupsContent',
                'opponentSummons': 'opponentSummonsContent',
                'opponentDamage': 'opponentDamageContent',
                'opponentBreakContent': 'opponentBreakContent'
            };

            const elementId = zoneMap[zoneName];
            return elementId ? document.getElementById(elementId) : null;
        }

        // Format zone name for display
        function formatZoneName(zoneName) {
            const nameMap = {
                'playerBackups': 'Your Backup Zone',
                'playerSummons': 'Your Summon Zone',
                'playerDamage': 'Your Damage Zone',
                'playerBreakContent': 'Your Break Zone',
                'opponentBackups': 'Opponent Backup Zone',
                'opponentSummons': 'Opponent Summon Zone',
                'opponentDamage': 'Opponent Damage Zone',
                'opponentBreakContent': 'Opponent Break Zone'
            };

            return nameMap[zoneName] || zoneName;
        }

        // Set up zone click handlers
        function setupZoneClickHandlers() {
            // Define zones that should be clickable (excluding field zones which no longer have headers)
            const clickableZones = [
                'playerDamage', 'opponentDamage'
            ];

            clickableZones.forEach(zoneName => {
                const zoneElement = document.getElementById(zoneName);
                if (zoneElement) {
                    const zoneHeader = zoneElement.querySelector('.zone-header');
                    if (zoneHeader) {
                        // Add clickable styling
                        zoneHeader.style.cursor = 'pointer';
                        zoneHeader.title = 'Click to view zone contents';
                        
                        // Add click handler
                        zoneHeader.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (document.getElementById('gameView').classList.contains('active')) {
                                showZoneOverviewModal(zoneName, 'zone');
                            }
                        });

                        // Add hover effect
                        zoneHeader.addEventListener('mouseenter', () => {
                            zoneHeader.style.background = 'linear-gradient(90deg, transparent 0%, rgba(255, 215, 0, 0.15) 50%, transparent 100%)';
                        });

                        zoneHeader.addEventListener('mouseleave', () => {
                            zoneHeader.style.background = 'linear-gradient(90deg, transparent 0%, rgba(255, 215, 0, 0.1) 50%, transparent 100%)';
                        });
                    }
                }
            });
        }

        // Handle zone overview modal events
        document.addEventListener('keydown', function(e) {
            // Close zone overview modal on any key press
            if (zoneOverviewModalOpen) {
                e.preventDefault();
                hideZoneOverviewModal();
            }
        });

        document.addEventListener('click', function(e) {
            // Close zone overview modal when clicking overlay
            if (zoneOverviewModalOpen && e.target.classList.contains('zone-overview-overlay')) {
                hideZoneOverviewModal();
            }
        });

        // Handle dynamic action button (Next Phase / End Turn)
        function handleDynamicAction() {
            if (window.app && window.app.gameEngine) {
                window.app.gameEngine.nextPhase();
            } else {
                console.error('Game Engine not available');
                window.showNotification('Game not active', 'error');
            }
        }

        // Open damage zone modal to view life points
        function openDamageZoneModal(player) {
            if (window.app && window.app.gameBoard) {
                window.app.gameBoard.showDamageZoneModal(player);
            } else {
                console.error('GameBoard not available');
                window.showNotification('Cannot view damage zone - game not active', 'error');
            }
        }

        // Toggle event log panel
        let eventLogOpen = false;
        function toggleEventLog() {
            const eventLog = document.getElementById('rightEventLog');
            const panel = document.getElementById('eventLogPanel');
            const toggle = document.getElementById('eventLogToggle');
            
            eventLogOpen = !eventLogOpen;
            
            if (eventLogOpen) {
                eventLog.classList.add('open');
                toggle.style.display = 'none';
            } else {
                eventLog.classList.remove('open');
                toggle.style.display = 'flex';
            }
            
            // Update event count when opening
            if (eventLogOpen && window.app && window.app.gameBoard) {
                window.app.gameBoard.updateEventLogStats();
            }
        }

        // Clear event log
        function clearRightEventLog() {
            if (window.app && window.app.gameBoard) {
                window.app.gameBoard.clearEventLog();
                document.getElementById('eventLogPanelContent').innerHTML = '<div class="event-log-empty">Event log cleared...</div>';
            }
        }

        // Test function to simulate damage (for testing FFTCG damage system)
        function testTakeDamage(player, amount = 1) {
            if (window.app && window.app.gameBoard) {
                window.app.gameBoard.takeDamage(player, amount);
            } else {
                console.warn('GameBoard not initialized yet');
            }
        }

        // Test function to check event log functionality
        function testEventLog() {
            console.log('=== EVENT LOG DEBUG TEST ===');
            
            // Check DOM elements first
            const eventLogArea = document.getElementById('eventLogArea');
            const eventLogContent = document.getElementById('eventLogContent');
            const eventLogPanelContent = document.getElementById('eventLogPanelContent');
            
            console.log('Event log area:', eventLogArea);
            console.log('Event log content (main):', eventLogContent);
            console.log('Event log panel content (right):', eventLogPanelContent);
            
            // Test basic container functionality FIRST
            console.log('=== BASIC CONTAINER TEST ===');
            const testEntry = document.createElement('div');
            testEntry.textContent = 'MANUAL TEST ENTRY - Should appear INSIDE the Game Events Log box';
            testEntry.style.background = 'red';
            testEntry.style.color = 'white';
            testEntry.style.padding = '10px';
            testEntry.style.margin = '5px';
            testEntry.style.border = '2px solid yellow';
            
            console.log('Adding manual test entry to eventLogContent...');
            eventLogContent.appendChild(testEntry);
            
            // Check where it appeared
            console.log('Container rect:', eventLogContent.getBoundingClientRect());
            console.log('Test entry rect:', testEntry.getBoundingClientRect());
            
            if (window.app && window.app.gameBoard) {
                const gameBoard = window.app.gameBoard;
                console.log('GameBoard event log content:', gameBoard.eventLog.content);
                console.log('Are they the same element?', eventLogContent === gameBoard.eventLog.content);
                
                // Test GameBoard method
                console.log('=== GAMEBOARD METHOD TEST ===');
                gameBoard.addEventLogEntry('phase-change', 'Test phase change message via GameBoard', {});
                
                // Check final state
                console.log('Final eventLogContent children:', eventLogContent.children);
            } else {
                console.warn('GameBoard not initialized yet');
            }
        }

        // Simple direct test without GameBoard
        function testDirectDOM() {
            console.log('=== DIRECT DOM TEST ===');
            const eventLogArea = document.getElementById('eventLogArea');
            const eventLogContent = document.getElementById('eventLogContent');
            
            if (!eventLogContent) {
                console.error('eventLogContent not found!');
                return;
            }
            
            console.log('Found eventLogArea:', eventLogArea);
            console.log('Found eventLogContent:', eventLogContent);
            console.log('eventLogContent parent:', eventLogContent.parentElement);
            
            // CHECK SCROLL STATE - This is key!
            console.log('üîç SCROLL INVESTIGATION:');
            console.log('eventLogContent.scrollTop:', eventLogContent.scrollTop);
            console.log('eventLogContent.scrollHeight:', eventLogContent.scrollHeight);
            console.log('eventLogContent.clientHeight:', eventLogContent.clientHeight);
            console.log('Is container scrolled?', eventLogContent.scrollTop > 0);
            
            // Check the exact position and size
            const containerRect = eventLogContent.getBoundingClientRect();
            const areaRect = eventLogArea.getBoundingClientRect();
            
            console.log('eventLogArea position:', areaRect);
            console.log('eventLogContent position:', containerRect);
            
            // Add a very obvious test element
            const directTest = document.createElement('div');
            directTest.style.cssText = `
                background: lime !important; 
                color: black !important; 
                padding: 15px !important; 
                border: 3px solid red !important; 
                margin: 10px !important;
                position: relative !important;
                z-index: 9999 !important;
            `;
            directTest.textContent = '‚≠ê DIRECT TEST - This should be INSIDE the box ‚≠ê';
            
            eventLogContent.appendChild(directTest);
            
            // Check where it ended up
            const testRect = directTest.getBoundingClientRect();
            console.log('Test element position (viewport):', testRect);
            
            // CORRECT TEST: Check if element is within container's CLIENT AREA
            // Not viewport coordinates, but relative to the container's scrollable area
            const isVisibleInContainer = testRect.top >= containerRect.top && 
                                       testRect.bottom <= containerRect.bottom &&
                                       testRect.left >= containerRect.left && 
                                       testRect.right <= containerRect.right;
            
            console.log('Is test element VISIBLE in container viewport?', isVisibleInContainer);
            
            // BETTER TEST: Check if element is actually contained within the DOM hierarchy
            const isContainedInDOM = eventLogContent.contains(directTest);
            console.log('‚úÖ Is element CONTAINED in DOM hierarchy?', isContainedInDOM);
            
            // ULTIMATE TEST: Check if any elements are actually escaping by testing overflow
            const containerStyle = window.getComputedStyle(eventLogContent);
            console.log('Container overflow-y:', containerStyle.overflowY);
            console.log('Container height:', containerStyle.height);
            
            if (eventLogContent.scrollHeight > eventLogContent.clientHeight) {
                console.log('üìù Container is scrollable - this is NORMAL behavior');
                console.log('Scroll height:', eventLogContent.scrollHeight);
                console.log('Client height:', eventLogContent.clientHeight);
                console.log('Elements with negative Y are just scrolled out of view - NOT escaped!');
            }
        }

        // Debug function to find all event log related elements
        function debugEventLogDOM() {
            console.log('=== EVENT LOG DOM ANALYSIS ===');
            
            // Find all elements with eventLog in ID
            const allEventLogElements = document.querySelectorAll('[id*="eventLog"]');
            console.log('All elements with eventLog in ID:', allEventLogElements);
            
            // Check for duplicates
            const eventLogContent = document.querySelectorAll('#eventLogContent');
            console.log('Elements with ID eventLogContent:', eventLogContent.length, eventLogContent);
            
            const eventLogArea = document.querySelectorAll('#eventLogArea');
            console.log('Elements with ID eventLogArea:', eventLogArea.length, eventLogArea);
            
            // Check current structure
            const mainContainer = document.getElementById('eventLogContent');
            if (mainContainer) {
                console.log('Main container children:', mainContainer.children);
                console.log('Main container innerHTML:', mainContainer.innerHTML);
                
                // Check if there are any absolutely positioned children
                Array.from(mainContainer.children).forEach((child, index) => {
                    const style = window.getComputedStyle(child);
                    console.log(`Child ${index}:`, child);
                    console.log(`  Position: ${style.position}`);
                    console.log(`  Display: ${style.display}`);
                    console.log(`  Location:`, child.getBoundingClientRect());
                });
            }
        }

        // Mulligan System Functions
        function showMulliganModal() {
            const modal = document.getElementById('mulliganModal');
            if (!modal) {
                console.error('Mulligan modal not found');
                return;
            }

            // Get current player hand from game engine
            if (window.app && window.app.gameEngine && window.app.gameEngine.gameState) {
                const playerHandIds = window.app.gameEngine.gameState.players[0].zones.hand || [];
                console.log('üÉè Player hand card IDs:', playerHandIds);
                populateMulliganHand(playerHandIds);
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            console.log('üîÑ Showing mulligan modal');
        }

        function hideMulliganModal() {
            const modal = document.getElementById('mulliganModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
                console.log('‚úÖ Hiding mulligan modal');
            }
        }

        function populateMulliganHand(handCardIds) {
            const container = document.getElementById('mulliganHandCards');
            if (!container) return;

            container.innerHTML = '';

            handCardIds.forEach((cardId, index) => {
                // Look up the actual card data from the card database
                let card = null;
                if (window.app && window.app.gameBoard && window.app.gameBoard.cardDatabase) {
                    card = window.app.gameBoard.cardDatabase.getCard(cardId);
                }

                const cardElement = document.createElement('div');
                cardElement.className = 'mulligan-card';
                
                if (card) {
                    // Get card image HTML using the same logic as GameBoard
                    let cardImageHTML = '';
                    if (window.app && window.app.gameBoard && window.app.gameBoard.getCardImageHTML) {
                        cardImageHTML = window.app.gameBoard.getCardImageHTML(card);
                    }

                    cardElement.innerHTML = `
                        <div class="mulligan-card-image">
                            ${cardImageHTML || 
                                `<div class="mulligan-card-placeholder">
                                    <div class="placeholder-icon">üé¥</div>
                                    <div class="placeholder-text">${card.name}</div>
                                </div>`
                            }
                        </div>
                        <div class="mulligan-card-info">
                            <div class="mulligan-card-name">${card.name}</div>
                            <div class="mulligan-card-cost">${card.cost || '?'}</div>
                        </div>
                    `;
                } else {
                    // Fallback if card lookup fails
                    cardElement.innerHTML = `
                        <div class="mulligan-card-image">
                            <div class="mulligan-card-placeholder">
                                <div class="placeholder-icon">‚ùì</div>
                            </div>
                        </div>
                        <div class="mulligan-card-info">
                            <div class="mulligan-card-name">Card ${cardId}</div>
                            <div class="mulligan-card-cost">?</div>
                        </div>
                    `;
                }
                
                container.appendChild(cardElement);
            });

            console.log(`üìã Populated mulligan preview with ${handCardIds.length} cards`);
        }

        function keepOpeningHand() {
            console.log('‚úÖ Player chose to keep opening hand');
            
            // Complete mulligan phase and proceed to active play
            if (window.app && window.app.gameEngine) {
                window.app.gameEngine.completeMulliganPhase();
            }
            
            hideMulliganModal();
            
            // Add event log entry
            if (window.app && window.app.gameBoard) {
                window.app.gameBoard.addEventLogEntry('mulligan', 'Player kept their opening hand');
            }
        }

        function mulliganOpeningHand() {
            console.log('üîÑ Player chose to mulligan opening hand');
            
            // Perform mulligan through game engine
            if (window.app && window.app.gameEngine) {
                window.app.gameEngine.redrawHand(0); // Player index 0
                
                // Complete mulligan phase and proceed to active play
                window.app.gameEngine.completeMulliganPhase();
            }
            
            hideMulliganModal();
            
            // Add event log entry
            if (window.app && window.app.gameBoard) {
                window.app.gameBoard.addEventLogEntry('mulligan', 'Player mulliganed their opening hand');
            }
        }

        // Initialize card hover tracking when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupCardHoverTracking();
            setupZoneClickHandlers();
            
            // Event log positioning has been fixed - no automatic testing needed
        });
    </script>
</body>
</html>